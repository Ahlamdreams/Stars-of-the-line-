<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الطابور المدرسي - متزامن</title>
    <!-- تضمين مكتبات التصدير -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* [الأنماط (CSS) بالكامل] */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; overflow-x: hidden; position: relative; min-height: 100vh; direction: rtl; }
        .live-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(45deg, #ff6b9d, #ffa726, #ab47bc, #42a5f5); background-size: 400% 400%; animation: modernGradientFlow 15s ease infinite; }
        .background-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 20% 50%, rgba(255, 107, 157, 0.3) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(171, 71, 188, 0.3) 0%, transparent 50%), radial-gradient(circle at 40% 80%, rgba(66, 165, 245, 0.3) 0%, transparent 50%); animation: modernBackgroundPulse 8s ease-in-out infinite; }
        .floating-particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        .glowing-orb { position: absolute; border-radius: 50%; background: radial-gradient(circle, rgba(255, 255, 255, 0.8), rgba(255, 107, 157, 0.4)); box-shadow: 0 0 20px rgba(255, 107, 157, 0.6); animation: floatOrb 20s linear infinite; }
        .sparkle { position: absolute; width: 4px; height: 4px; background: white; border-radius: 50%; box-shadow: 0 0 10px white; animation: sparkleMove 8s linear infinite; }
        .glass-morphism { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .header { padding: 2rem; margin: 1rem; position: relative; overflow: hidden; }
        .header::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(from 0deg, transparent, rgba(255, 255, 255, 0.1), transparent); animation: rotate 10s linear infinite; }
        .logo-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .logo { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; box-shadow: 0 0 30px rgba(255, 107, 157, 0.5); animation: logoPulse 3s ease-in-out infinite; position: relative; z-index: 2; overflow: hidden; }
        .logo img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .header-logo-image { width: 120px; height: 120px; border-radius: 15px; object-fit: cover; border: 3px solid rgba(255, 255, 255, 0.4); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; }
        .header-logo-image:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
        .main-title { text-align: center; font-size: 3.5rem; font-weight: 900; background: linear-gradient(45deg, #ff6b9d, #ffa726, #ab47bc, #42a5f5); background-size: 400% 400%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: modernGradientFlow 8s ease infinite, textGlow 2s ease-in-out infinite alternate; text-shadow: 0 0 30px rgba(255, 107, 157, 0.5); margin: 1rem 0; position: relative; z-index: 2; }
        .subtitle { text-align: center; font-size: 1.2rem; color: rgba(255, 255, 255, 0.9); margin-bottom: 2rem; position: relative; z-index: 2; }
        .header-info { display: flex; justify-content: space-between; align-items: center; gap: 2rem; margin: 2rem 0; position: relative; z-index: 2; }
        .header-image { width: 200px; height: 200px; border-radius: 15px; object-fit: cover; border: 3px solid rgba(255, 255, 255, 0.3); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; }
        .header-image:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
        .info-card { padding: 1rem 2rem; text-align: center; color: white; font-size: 1.1rem; }
        
        /* === أنماط بطاقات النجوم (Stars Summary) === */
        .stars-summary { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 1rem; 
            margin-top: 2rem; 
            position: relative; 
            z-index: 2; 
        }

        .star-card {
            width: 100%; 
            color: white; 
            padding: 1rem; 
            text-align: center;
        }

        .star-card h3 {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .star-card p {
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }

        /* الألوان المطلوبة لبطاقات النجوم */
        .star-card:nth-child(1) { 
            background: linear-gradient(135deg, #ab47bc, #e1bee7); /* بنفسجي - نجمة الشهر */
        }
        
        .star-card:nth-child(2) { 
            background: linear-gradient(135deg, #ffa726, #ffcc02); /* أصفر - نجم الطابور */
        }
        
        .star-card:nth-child(3) { 
            background: linear-gradient(135deg, #ff6b9d, #ff8a80); /* وردي - نجمة اليوم */
        }

        .star-card:nth-child(4) { 
            background: linear-gradient(135deg, #42a5f5, #81d4fa); /* أزرق - نجم الطابور للشهر */
        }
        /* ============================================== */

        .star-card:hover { transform: translateY(-10px) scale(1.05); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2); }
        .navigation { position: sticky; top: 0; z-index: 100; margin: 0 1rem; padding: 1rem; display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
        .nav-button { padding: 1rem 2rem; background: linear-gradient(45deg, #ff6b9d, #ffa726); color: white; border: none; border-radius: 15px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; display: flex; align-items: center; gap: 0.5rem; }
        .nav-button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent); transition: left 0.5s ease; }
        .nav-button:hover::before { left: 100%; }
        .nav-button:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }
        .nav-button.active { background: linear-gradient(45deg, #ab47bc, #42a5f5); box-shadow: 0 0 20px rgba(171, 71, 188, 0.5); }
        .main-content { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .section { display: none; animation: fadeInUp 0.5s ease; }
        .section.active { display: block; }
        .attendance-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { padding: 1.5rem; text-align: center; color: white; position: relative; overflow: hidden; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px) rotateX(10deg); }
        .stat-number { font-size: 2.5rem; font-weight: 900; margin-bottom: 0.5rem; }
        .stat-label { font-size: 1.1rem; opacity: 0.9; }
        .teachers-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        
        /* === أنماط بطاقات المعلمات (Teacher Card Status) === */
        .teacher-card { 
            padding: 1.5rem; 
            position: relative; 
            overflow: hidden; 
            transition: all 0.5s ease; 
            cursor: pointer; 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .teacher-card.status-present {
            background: linear-gradient(135deg, #4caf50, #81c784); /* أخضر - حاضر */
            box-shadow: 0 8px 32px rgba(76, 175, 80, 0.4);
        }

        .teacher-card.status-absent {
            background: linear-gradient(135deg, #f44336, #ef5350); /* أحمر - غائب */
            box-shadow: 0 8px 32px rgba(244, 67, 54, 0.4);
        }

        .teacher-card.status-late {
            background: linear-gradient(135deg, #ff9800, #ffb74d); /* برتقالي - متأخر */
            box-shadow: 0 8px 32px rgba(255, 152, 0, 0.4);
        }

        .teacher-card.status-excused {
            background: linear-gradient(135deg, #2196f3, #64b5f6); /* أزرق - بعذر */
            box-shadow: 0 8px 32px rgba(33, 150, 243, 0.4);
        }
        
        .teacher-card.status-not-recorded {
            background: rgba(255, 255, 255, 0.1); 
        }
        /* ============================================== */

        .teacher-card:hover { transform: translateY(-10px) rotateY(5deg) rotateX(5deg); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2); }
        .teacher-avatar { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(45deg, #ff6b9d, #ffa726); display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; margin: 0 auto 1rem; box-shadow: 0 0 20px rgba(255, 107, 157, 0.3); }
        .teacher-name { font-size: 1.3rem; font-weight: 700; text-align: center; margin-bottom: 0.5rem; color: white; }
        .teacher-class { text-align: center; color: rgba(255, 255, 255, 0.8); margin-bottom: 1rem; }
        .attendance-status { display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 1rem; }
        .status-btn { padding: 0.5rem 1rem; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem; font-weight: 600; }
        .status-btn.present { background: #4caf50; color: white; }
        .status-btn.absent { background: #f44336; color: white; }
        .status-btn.late { background: #ff9800; color: white; }
        .status-btn.excused { background: #2196f3; color: white; }
        .status-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }
        .teacher-actions { display: flex; justify-content: center; gap: 0.5rem; }
        .action-btn { padding: 0.5rem; border: none; border-radius: 8px; background: rgba(255, 255, 255, 0.2); color: white; cursor: pointer; transition: all 0.3s ease; }
        .action-btn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .classes-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
        
        /* === نمط بطاقة الصف الفائز بنجم الطابور === */
        .class-card { 
            padding: 2rem; 
            position: relative; 
            overflow: hidden; 
            transition: all 0.5s ease;
            border: 1px solid rgba(255, 255, 255, 0.2); /* الافتراضي */
        }
        
        .class-card.queue-star-winner {
            background: linear-gradient(45deg, #f0e68c, #ffd700); /* لون ذهبي لامع */
            border: 3px solid white; 
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
            transform: scale(1.05); /* إبراز أكبر */
        }

        .class-card.queue-star-winner .class-name, 
        .class-card.queue-star-winner .class-points,
        .class-card.queue-star-winner .criteria-name,
        .class-card.queue-star-winner .criteria-points {
            color: #333; /* تغيير لون النص إلى الداكن ليظهر على الخلفية الذهبية */
            font-weight: 900;
        }

        .class-card.queue-star-winner .criteria-row {
            background: rgba(255, 255, 255, 0.5);
        }
        /* =========================================== */

        .class-card:hover { transform: translateY(-10px) rotateY(5deg) rotateX(5deg); }
        .class-name { font-size: 1.5rem; font-weight: 700; text-align: center; color: white; }
        .class-points { text-align: center; font-size: 2rem; font-weight: 900; color: #ffa726; margin-bottom: 1.5rem; }
        .criteria-controls { display: flex; flex-direction: column; gap: 1rem; }
        .criteria-row { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .criteria-name { color: white; font-weight: 600; }
        .criteria-controls-btn { display: flex; align-items: center; gap: 1rem; }
        .point-btn { width: 40px; height: 40px; border: none; border-radius: 50%; font-size: 1.2rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; }
        .point-btn.plus { background: #4caf50; color: white; }
        .point-btn.minus { background: #f44336; color: white; }
        .point-btn:hover { transform: scale(1.2); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        .criteria-points { color: white; font-weight: 700; font-size: 1.1rem; min-width: 30px; text-align: center; }
        .system-management { max-width: 800px; margin: 0 auto; }
        .password-prompt { text-align: center; padding: 3rem; }
        .password-input { padding: 1rem; font-size: 1.2rem; border: none; border-radius: 10px; background: rgba(255, 255, 255, 0.2); color: white; text-align: center; margin: 1rem; width: 300px; }
        .password-input::placeholder { color: rgba(255, 255, 255, 0.7); }
        .tabs { display: flex; justify-content: center; margin-bottom: 2rem; gap: 0.5rem; flex-wrap: wrap; }
        .tab-btn { padding: 1rem 2rem; background: rgba(255, 255, 255, 0.1); color: white; border: none; border-radius: 10px 10px 0 0; cursor: pointer; transition: all 0.3s ease; }
        .tab-btn.active { background: rgba(255, 255, 255, 0.2); box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1); }
        .tab-content { display: none; padding: 2rem; background: rgba(255, 255, 255, 0.1); border-radius: 15px; backdrop-filter: blur(20px); }
        .tab-content.active { display: block; }
        @keyframes modernGradientFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes modernBackgroundPulse { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.1); } }
        @keyframes floatOrb { 0% { transform: translateY(100vh) translateX(0) rotate(0deg); } 100% { transform: translateY(-100px) translateX(100px) rotate(360deg); } }
        @keyframes sparkleMove { 0% { transform: translateY(100vh); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }
        @keyframes rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes logoPulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(255, 107, 157, 0.5); } 50% { transform: scale(1.1); box-shadow: 0 0 50px rgba(255, 107, 157, 0.8); } }
        @keyframes textGlow { 0% { text-shadow: 0 0 30px rgba(255, 107, 157, 0.5); } 100% { text-shadow: 0 0 50px rgba(255, 107, 157, 0.8), 0 0 70px rgba(255, 165, 38, 0.6); } }
        @keyframes fadeInUp { 0% { opacity: 0; transform: translateY(30px); } 100% { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { 
            .main-title { font-size: 2.5rem; } 
            .header-info { flex-direction: column; gap: 1rem; } 
            .header-image { width: 150px; height: 150px; } 
            .navigation { flex-direction: column; } 
            .teachers-grid, .classes-grid { grid-template-columns: 1fr; } 
            .attendance-stats { grid-template-columns: repeat(2, 1fr); } 
            .tabs { flex-direction: column; } 
            .stars-summary { grid-template-columns: 1fr; }
            .star-card { margin: 0.5rem 0; }
        }
        .loading { display: flex; justify-content: center; align-items: center; padding: 2rem; color: white; font-size: 1.2rem; }
        .loading::after { content: ''; width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); z-index: 10000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 249, 250, 0.9)); border-radius: 20px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); border: 2px solid rgba(255, 107, 157, 0.3); position: relative; animation: slideInUp 0.3s ease; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid rgba(255, 107, 157, 0.2); }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: #ff6b9d; margin: 0; }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: #666; cursor: pointer; padding: 0.5rem; border-radius: 50%; transition: all 0.3s ease; }
        .modal-close:hover { background: rgba(244, 67, 54, 0.1); color: #f44336; transform: scale(1.1); }
        .modal-body { color: #333; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333; }
        .form-input { width: 100%; padding: 1rem; border: 2px solid rgba(255, 107, 157, 0.3); border-radius: 10px; font-size: 1rem; font-family: 'Tajawal', sans-serif; background: rgba(255, 255, 255, 0.8); transition: all 0.3s ease; }
        .form-input:focus { outline: none; border-color: #ff6b9d; box-shadow: 0 0 20px rgba(255, 107, 157, 0.3); background: white; }
        .form-textarea { min-height: 120px; resize: vertical; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }
        .modal-btn { padding: 0.8rem 2rem; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: 'Tajawal', sans-serif; }
        .modal-btn-primary { background: linear-gradient(45deg, #ff6b9d, #ffa726); color: white; }
        .modal-btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }
        .modal-btn-secondary { background: rgba(108, 117, 125, 0.1); color: #6c757d; border: 2px solid rgba(108, 117, 125, 0.3); }
        .modal-btn-secondary:hover { background: rgba(108, 117, 125, 0.2); transform: translateY(-3px); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(50px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .notes-indicator { position: absolute; top: 10px; left: 10px; background: linear-gradient(45deg, #ffa726, #ffcc02); color: white; font-size: 0.8rem; padding: 0.3rem 0.6rem; border-radius: 15px; font-weight: 600; box-shadow: 0 2px 10px rgba(255, 165, 38, 0.4); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .report-preview-container { font-family: 'Tajawal', sans-serif; direction: rtl; padding: 2rem; border-radius: 15px; background: white; color: #333; text-align: right; }
        .report-header { text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #ddd; padding-bottom: 1rem; }
        .report-title { font-size: 2rem; margin-bottom: 0.5rem; }
        .report-date { font-size: 1.1rem; color: #666; }
        .report-section-title { font-size: 1.5rem; margin-top: 2rem; margin-bottom: 1rem; border-right: 4px solid #ab47bc; padding-right: 1rem; }
        .report-list { list-style: none; padding: 0; margin: 0; }
        .report-list-item { padding: 0.75rem 1rem; border-bottom: 1px dashed #ddd; display: flex; justify-content: space-between; align-items: center; }
        .report-list-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="live-background"></div>
    <div class="background-overlay"></div>

    <div class="floating-particles" id="particles"></div>

    <header class="header glass-morphism">
        <div class="logo-container" id="siteHeaderLogo">
            <div class="logo">
                ⭐
            </div>
            <!-- تم إبقاء الصور الوهمية لتجنب ظهور أخطاء في الكونسول إذا لم يتم توفير روابط حقيقية -->
            <img src="https://lh3.googleusercontent.com/d/1mtn3vRqkD9EotyQGuBAVxjTKxUyzSr3Y" 
                        alt="شعار المدرسة" 
                        class="header-logo-image"
                        onerror="this.style.display='none'; console.log('فشل في تحميل الصورة');"
                        onload="console.log('تم تحميل الصورة بنجاح');">
            <img src="https://lh3.googleusercontent.com/d/1ER6aW7lGipFE4oZ3LW0vftXyoT9Lmf1n" 
                        alt="صورة المدرسة" 
                        class="header-logo-image"
                        onerror="this.style.display='none'; console.log('فشل في تحميل الصورة');"
                        onload="console.log('تم تحميل الصورة بنجاح');">
        </div>
        
        <h1 class="main-title">الطابور المدرسي</h1>
        <p class="subtitle" id="motivationalSubtitle">انضباط يعكس وعيًا ونظام يصنع الأجيال</p>
        
        <div class="header-info">
            <div class="info-card glass-morphism">
                <div>مديرة المدرسة: أ.أحلام بنت علي الحمدانية</div>
                <div id="currentDateTime"></div>
            </div>
        </div>

        <div class="stars-summary">
            <div class="star-card glass-morphism">
                <h3>🏆 نجمة الشهر</h3>
                <p id="starOfMonth">لم يتم الاختيار بعد</p>
            </div>
            <div class="star-card glass-morphism">
                <h3>⭐ نجم الطابور</h3>
                <p id="queueStar">لم يتم الاختيار بعد</p>
            </div>
            <div class="star-card glass-morphism">
                <h3>🌟 نجمة اليوم</h3>
                <p id="starOfDay">لم يتم الاختيار بعد</p>
            </div>
            <div class="star-card glass-morphism">
                <h3>👑 نجم الطابور للشهر</h3>
                <p id="queueStarMonth">لم يتم الاختيار بعد</p>
            </div>
        </div>
    </header>

    <nav class="navigation glass-morphism">
        <button class="nav-button active" onclick="showSection('attendance')">
            👥 حضور المعلمات
        </button>
        <button class="nav-button" onclick="showSection('queue-star')">
            ⭐ نجم الطابور
        </button>
        <button class="nav-button" onclick="showSection('system-management')">
            ⚙️ إدارة النظام
        </button>
    </nav>

    <main class="main-content">
        <section id="attendance" class="section active">
            <div class="attendance-stats">
                <div class="stat-card glass-morphism" style="background: linear-gradient(135deg, #4caf50, #81c784);">
                    <div class="stat-number" id="presentCount">0</div>
                    <div class="stat-label">حاضرات</div>
                </div>
                <div class="stat-card glass-morphism" style="background: linear-gradient(135deg, #f44336, #ef5350);">
                    <div class="stat-number" id="absentCount">0</div>
                    <div class="stat-label">غائبات</div>
                </div>
                <div class="stat-card glass-morphism" style="background: linear-gradient(135deg, #ff9800, #ffb74d);">
                    <div class="stat-number" id="notRecordedCount">0</div>
                    <div class="stat-label">لم يتم التسجيل</div>
                </div>
                <div class="stat-card glass-morphism" style="background: linear-gradient(135deg, #2196f3, #64b5f6);">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">الإجمالي</div>
                </div>
            </div>

            <div class="glass-morphism" style="padding: 2rem; margin: 2rem 0;">
                <h3 style="color: white; text-align: center; margin-bottom: 1rem;">سجل الحضور اليومي</h3>
                <div id="attendanceLog" style="color: white; text-align: center;">
                    جاري تحميل بيانات الحضور...
                </div>
            </div>

            <div class="teachers-grid" id="teachersGrid">
                <div class="glass-morphism loading" style="padding: 3rem; text-align: center; color: white; grid-column: 1 / -1;">
                    جاري تحميل بيانات المعلمات من الخادم...
                </div>
            </div>
        </section>

        <section id="queue-star" class="section">
            <div class="classes-grid" id="classesGrid">
                <div class="glass-morphism loading" style="padding: 3rem; text-align: center; color: white; grid-column: 1 / -1;">
                    جاري تحميل بيانات الصفوف من الخادم...
                </div>
            </div>
        </section>

        <section id="system-management" class="section">
            <div class="system-management glass-morphism">
                <div id="passwordPrompt" class="password-prompt">
                    <h2 style="color: white; margin-bottom: 2rem;">🔒 إدخال كلمة المرور</h2>
                    <input type="password" class="password-input glass-morphism" placeholder="كلمة المرور" id="systemPassword">
                    <br>
                    <button class="nav-button" onclick="checkSystemPassword()">دخول</button>
                </div>

                <div id="systemContent" style="display: none;">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="showTab('teachers-management', this)">إدارة المعلمات</button>
                        <button class="tab-btn" onclick="showTab('stars-management', this)">إدارة النجوم</button>
                        <button class="tab-btn" onclick="showTab('certificates', this)">طباعة الشهادات</button>
                        <button class="tab-btn" onclick="showTab('reports', this)">تصدير التقارير</button>
                        <button class="tab-btn" onclick="showTab('settings', this)">الإعدادات</button>
                    </div>

                    <div id="teachers-management" class="tab-content active">
                        <h3 style="color: white; text-align: center; margin-bottom: 2rem;">إدارة المعلمات والبيانات</h3>
                        
                        <div class="glass-morphism" style="padding: 2rem; margin-bottom: 2rem;">
                            <h4 style="color: white; margin-bottom: 1rem;">📊 معلومات النظام</h4>
                            <div id="dataManagementInfo" style="color: white; margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 10px;">
                                </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <button class="nav-button" onclick="loadDataFromSheet()">🔄 تحديث البيانات من الشيت</button>
                                <button class="nav-button" onclick="exportSavedData()">📤 تصدير نسخة احتياطية</button>
                                <button class="nav-button" onclick="importSavedData()">📥 استيراد نسخة احتياطية</button>
                                <button class="nav-button" onclick="clearAllSavedData()" style="background: #f44336;">🗑️ مسح البيانات المحلية</button>
                            </div>
                        </div>
                        
                        <div class="glass-morphism" style="padding: 2rem; margin-bottom: 2rem;">
                            <h4 style="color: white; margin-bottom: 1rem;">📋 رابط الشيت للبيانات</h4>
                            <div style="color: white; margin-bottom: 1rem; padding: 1rem; background: rgba(33, 150, 243, 0.2); border-radius: 10px;">
                                <p style="margin-bottom: 0.5rem;">**ملاحظة:** النظام الآن يتزامن مع الشيت. **لإضافة معلمة جديدة، يفضل إضافتها مباشرة في ورقة "Teachers" في Google Sheet لإعطائها ID صحيح**.</p>
                            </div>
                            <div style="color: white; font-size: 0.9rem; word-break: break-all; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                                <strong>🔗 رابط الشيت المرجعي (API):</strong><br>
                                <span id="apiLinkDisplay"></span>
                            </div>
                        </div>
                        
                        <div class="glass-morphism" style="padding: 2rem; margin-bottom: 2rem;">
                            <h4 style="color: white; margin-bottom: 1rem;">إجراءات اليوم الجديد (سجل تاريخي)</h4>
                            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                <button class="nav-button" onclick="resetAllAttendance()" style="background: linear-gradient(45deg, #e7823f, #ffaa00); border: 2px solid rgba(255, 255, 255, 0.5);">
                                    💾 أرشفة ومسح سجل الحضور (يدوي)
                                </button>
                                <p style="color: rgba(255,255,255,0.7); margin-top: 10px;">(يتم تشغيله تلقائياً عند 12:00 صباحاً)</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                            <button class="nav-button" onclick="showAddTeacherForm()">➕ إضافة معلمة جديدة (محلياً فقط)</button>
                        </div>

                        <div class="glass-morphism" style="padding: 2rem; margin-bottom: 2rem;">
                            <h4 style="color: white; margin-bottom: 1rem;">📊 إدارة النقاط</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <button class="nav-button" onclick="resetAllDailyPoints()">📅 مسح نقاط اليوم لجميع الصفوف</button>
                                <button class="nav-button" onclick="addAllDailyToMonthly()">📊 إضافة نقاط اليوم للشهر</button>
                                <button class="nav-button" onclick="resetAllMonthlyPoints()">🗓️ مسح النقاط الشهرية</button>
                                <button class="nav-button" onclick="resetAllPoints()">🔄 مسح جميع النقاط</button>
                            </div>
                        </div>

                        <div id="addTeacherForm" class="tab-content">
                            <h4 style="color: white; margin-bottom: 1rem;">إضافة معلمة جديدة</h4>
                            <div style="display: flex; justify-content: center; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                <input type="text" id="newTeacherName" placeholder="اسم المعلمة" class="password-input glass-morphism" style="width: 200px;">
                                <input type="text" id="newTeacherClass" placeholder="الصف" class="password-input glass-morphism" style="width: 150px;">
                                <button class="nav-button" onclick="addNewTeacher()">إضافة</button>
                                <button class="nav-button" onclick="hideAddTeacherForm()" style="background: #f44336;">إلغاء</button>
                            </div>
                        </div>

                        <div class="glass-morphism" style="padding: 2rem;">
                            <h4 style="color: white; margin-bottom: 1rem;">قائمة المعلمات</h4>
                            <div id="teachersManagementList" style="max-height: 400px; overflow-y: auto;">
                                </div>
                        </div>
                    </div>

                    <div id="stars-management" class="tab-content">
                        <h3 style="color: white; text-align: center; margin-bottom: 2rem;">إدارة النجوم</h3>
                        
                        <div class="glass-morphism" style="padding: 2rem; margin-bottom: 2rem;">
                            <h4 style="color: white; margin-bottom: 1rem;">اختيار نجوم اليوم</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                                <div>
                                    <label style="color: white; display: block; margin-bottom: 0.5rem;">🌟 نجمة اليوم:</label>
                                    <select id="starOfDaySelect" class="password-input glass-morphism" style="width: 100%;">
                                        <option value="">اختر المعلمة</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="color: white; display: block; margin-bottom: 0.5rem;">⭐ نجم الطابور:</label>
                                    <select id="queueStarSelect" class="password-input glass-morphism" style="width: 100%;">
                                        <option value="">اختر الصف</option>
                                    </select>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <button class="nav-button" onclick="updateDailyStars()">تحديث نجوم اليوم</button>
                            </div>
                        </div>

                        <div class="glass-morphism" style="padding: 2rem;">
                            <h4 style="color: white; margin-bottom: 1rem;">نجوم الشهر</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                                <div>
                                    <label style="color: white; display: block; margin-bottom: 0.5rem;">🏆 نجمة الشهر:</label>
                                    <select id="starOfMonthSelect" class="password-input glass-morphism" style="width: 100%;">
                                        <option value="">اختر المعلمة</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="color: white; display: block; margin-bottom: 0.5rem;">👑 نجم الطابور للشهر:</label>
                                    <select id="queueStarMonthSelect" class="password-input glass-morphism" style="width: 100%;">
                                        <option value="">اختر الصف</option>
                                    </select>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <button class="nav-button" onclick="updateMonthlyStars()">تحديث نجوم الشهر</button>
                            </div>
                        </div>
                    </div>

                    <div id="certificates" class="tab-content">
                        <h3 style="color: white; text-align: center; margin-bottom: 2rem;">طباعة الشهادات</h3>
                        
                        <div style="display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                            <!-- الدوال تستدعي دالة createStarCertificate الجديدة -->
                            <button class="nav-button" onclick="createStarCertificate('starOfDay')">🌟 شهادة نجمة اليوم</button>
                            <button class="nav-button" onclick="createStarCertificate('dailyClass')">⭐ شهادة نجم الطابور</button>
                            <button class="nav-button" onclick="createStarCertificate('starOfMonth')">🏆 شهادة نجمة الشهر</button>
                            <button class="nav-button" onclick="createStarCertificate('queueStarMonth')">👑 شهادة نجم الطابور للشهر</button>
                            <button class="nav-button" onclick="createStarCertificate('attendance')">📋 شهادة الحضور</button>
                        </div>

                        <div class="glass-morphism" style="padding: 2rem;">
                            <h4 style="color: white; margin-bottom: 1rem;">معاينة الشهادة (انقر على زر الشهادة للتصدير)</h4>
                            <!-- هنا سيتم عرض محتوى الشهادة الديناميكي -->
                            <div id="certificatePreviewContainer" style="background: white; padding: 2rem; border-radius: 15px; text-align: center; color: #333; min-height: 400px; position: relative;">
                                <p id="certificatePlaceholder">اختر نوع الشهادة لمعاينتها (سيتم تصديرها كـ PDF مباشرة)</p>
                            </div>
                        </div>
                    </div>

                    <div id="reports" class="tab-content">
                        <h3 style="color: white; text-align: center; margin-bottom: 2rem;">تصدير التقارير والبيانات</h3>
                        
                        <div class="glass-morphism" style="padding: 2rem; margin-bottom: 2rem;">
                            <h4 style="color: white; margin-bottom: 1rem;">📊 تقارير الحضور</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                <button class="nav-button" onclick="generateAndExportDailyAttendance('image')">📸 تقرير يومي (صورة)</button>
                                <button class="nav-button" onclick="generateAndExportDailyAttendance('excel')">📊 تقرير يومي (Excel)</button>
                                <button class="nav-button" onclick="generateAndExportDailyAttendance('pdf')">📄 تقرير يومي (PDF)</button>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                <button class="nav-button" onclick="generateAndExportWeeklyAttendance('image')">📸 تقرير أسبوعي (صورة)</button>
                                <button class="nav-button" onclick="generateAndExportWeeklyAttendance('excel')">📊 تقرير أسبوعي (Excel)</button>
                                <button class="nav-button" onclick="generateAndExportWeeklyAttendance('pdf')">📄 تقرير أسبوعي (PDF)</button>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <button class="nav-button" onclick="generateAndExportMonthlyAttendance('image')">📸 تقرير شهري (صورة)</button>
                                <button class="nav-button" onclick="generateAndExportMonthlyAttendance('excel')">📊 تقرير شهري (Excel)</button>
                                <button class="nav-button" onclick="generateAndExportMonthlyAttendance('pdf')">📄 تقرير شهري (PDF)</button>
                            </div>
                        </div>

                        <div class="glass-morphism" style="padding: 2rem; margin-bottom: 2rem;">
                            <h4 style="color: white; margin-bottom: 1rem;">⭐ تقارير نجوم الطابور</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                <button class="nav-button" onclick="generateAndExportDailyStars('image')">📸 نجوم يومية (صورة)</button>
                                <button class="nav-button" onclick="generateAndExportDailyStars('excel')">📊 نجوم يومية (Excel)</button>
                                <button class="nav-button" onclick="generateAndExportDailyStars('pdf')">📄 نجوم يومية (PDF)</button>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                <button class="nav-button" onclick="generateAndExportWeeklyStars('image')">📸 نجوم أسبوعية (صورة)</button>
                                <button class="nav-button" onclick="generateAndExportWeeklyStars('excel')">📊 نجوم أسبوعية (Excel)</button>
                                <button class="nav-button" onclick="generateAndExportWeeklyStars('pdf')">📄 نجوم أسبوعية (PDF)</button>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <button class="nav-button" onclick="generateAndExportMonthlyStars('image')">📸 نجوم شهرية (صورة)</button>
                                <button class="nav-button" onclick="generateAndExportMonthlyStars('excel')">📊 نجوم شهرية (Excel)</button>
                                <button class="nav-button" onclick="generateAndExportMonthlyStars('pdf')">📄 نجوم شهرية (PDF)</button>
                            </div>
                        </div>

                        <div class="glass-morphism" style="padding: 2rem; margin-bottom: 2rem;">
                            <h4 style="color: white; margin-bottom: 1rem;">📋 التقارير الشاملة</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <button class="nav-button" onclick="exportCompleteReport('excel')">📊 تقرير شامل (Excel)</button>
                                <button class="nav-button" onclick="exportCompleteReport('pdf')">📄 تقرير شامل (PDF)</button>
                            </div>
                        </div>

                        <div class="glass-morphism" style="padding: 2rem;">
                            <h4 style="color: white; margin-bottom: 1rem;">👁️ معاينة التقرير</h4>
                            <div id="reportPreviewContainer" style="background: white; padding: 2rem; border-radius: 15px; text-align: center; color: #333; min-height: 300px; max-height: 500px; overflow-y: auto;">
                                <p id="reportPlaceholder">اختر نوع التقرير لمعاينته</p>
                                <!-- هنا سيتم عرض محتوى التقرير المخفي -->
                                <div id="reportToExport" style="display:none; padding:1rem; border:2px solid #333; background:white; max-width:900px; margin:auto;">
                                    <!-- محتوى التقرير (جدول HTML) يُملأ تلقائيًا -->
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <button class="nav-button" onclick="printReport()">🖨️ طباعة التقرير</button>
                            </div>
                        </div>
                    </div>

                    <div id="settings" class="tab-content">
                        <h3 style="color: white; text-align: center;">الإعدادات</h3>
                        <div style="color: white;">
                            <div style="margin: 1rem 0;">
                                <label>كلمة مرور النظام:</label>
                                <input type="password" class="password-input glass-morphism" id="newSystemPassword" placeholder="كلمة المرور الجديدة">
                                <button class="nav-button" onclick="updateSystemPassword()">تحديث</button>
                            </div>
                            <div style="margin: 1rem 0;">
                                <label>العبارة التحفيزية:</label>
                                <input type="text" class="password-input glass-morphism" id="motivationalText" placeholder="انضباط يعكس وعيًا ونظام يصنع الأجيال" style="width: 400px;">
                                <button class="nav-button" onclick="updateMotivationalText()">تحديث</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- النوافذ المنبثقة (MODALS) -->
    <div id="teacherModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تعديل بيانات المعلمة</h3>
                <button class="modal-close" onclick="closeTeacherModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">اسم المعلمة:</label>
                    <input type="text" id="editTeacherName" class="form-input" placeholder="اسم المعلمة">
                </div>
                <div class="form-group">
                    <label class="form-label">الصف:</label>
                    <input type="text" id="editTeacherClass" class="form-input" placeholder="الصف">
                </div>
                <div class="form-group">
                    <label class="form-label">الملاحظات:</label>
                    <textarea id="editTeacherNotes" class="form-input form-textarea" placeholder="أضف ملاحظات حول المعلمة..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeTeacherModal()">إلغاء</button>
                <button class="modal-btn modal-btn-primary" onclick="saveTeacherChanges()">حفظ التغييرات</button>
            </div>
        </div>
    </div>

    <div id="classModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تعديل بيانات الصف</h3>
                <button class="modal-close" onclick="closeClassModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">اسم الصف:</label>
                    <input type="text" id="editClassName" class="form-input" placeholder="اسم الصف">
                </div>
                <div class="form-group">
                    <label class="form-label">الملاحظات:</label>
                    <textarea id="editClassNotes" class="form-input form-textarea" placeholder="أضف ملاحظات حول الصف..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeClassModal()">إلغاء</button>
                <button class="modal-btn modal-btn-primary" onclick="saveClassChanges()">حفظ التغييرات</button>
            </div>
        </div>
    </div>

    <div id="cameraModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title">📸 تصوير الطابور</h3>
                <button class="modal-close" onclick="closeCameraModal()">×</button>
            </div>
            <div class="modal-body">
                <div id="cameraContainer" style="text-align: center;">
                    <div id="cameraPreview" style="position: relative; margin-bottom: 1rem;">
                        <video id="cameraVideo" style="width: 100%; max-width: 600px; height: auto; border-radius: 10px; background: #000;" autoplay muted></video>
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                        
                        <div id="photoOverlay" style="position: absolute; bottom: 10px; left: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 8px; font-family: 'Tajawal', sans-serif;">
                            <div id="overlayTeacherName" style="font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;"></div>
                            <div id="overlayClassName" style="font-size: 1rem; margin-bottom: 5px;"></div>
                            <div id="overlayDateTime" style="font-size: 0.9rem; opacity: 0.9;"></div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <button id="startCameraBtn" class="modal-btn modal-btn-primary" onclick="startCamera()">
                            📹 تشغيل الكاميرا
                        </button>
                        <button id="captureBtn" class="modal-btn modal-btn-primary" onclick="capturePhoto()" style="display: none;">
                            📸 التقاط الصورة
                        </button>
                        <button id="switchCameraBtn" class="modal-btn modal-btn-secondary" onclick="switchCamera()" style="display: none;">
                            🔄 تبديل الكاميرا
                        </button>
                        <button id="stopCameraBtn" class="modal-btn modal-btn-secondary" onclick="stopCamera()" style="display: none;">
                            ⏹️ إيقاف الكاميرا
                        </button>
                    </div>
                    
                    <div id="capturedPhotos" style="display: none;">
                        <h4 style="color: #333; margin-bottom: 1rem;">الصور المحفوظة:</h4>
                        <div id="photosGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; max-height: 300px; overflow-y: auto;">
                            </div>
                    </div>
                    
                    <div id="cameraStatus" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;">
                        </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeCameraModal()">إغلاق</button>
                <button class="modal-btn modal-btn-primary" onclick="downloadAllPhotos()" id="downloadAllBtn" style="display: none;">
                    💾 تحميل جميع الصور
                </button>
            </div>
        </div>
    </div>

    <script>
        // =======================================================
        // 1. إعداد متغيرات النظام للمزامنة
        // =======================================================
        let teachers = [];
        let classes = [];

        // ⚠️ كلمة المرور الافتراضية
        let systemPassword = 'admin123';
        let motivationalQuote = 'انضباط يعكس وعيًا ونظام يصنع الأجيال';

        // ⭐️ الرابط المحدث بناءً على طلبك الأخير
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbzyEx0-gmYstNeOETO5FSlPkNawtmSJzkCE35M8Mk1dthVrnH2klKcV5cznKebDLvWR/exec'; 

        // متغيرات العمليات
        let currentEditingTeacherId = null;
        let currentEditingClassIndex = null;
        let currentCameraTeacherId = null;
        let cameraStream = null;
        let currentCameraIndex = 0;
        let availableCameras = [];
        let capturedPhotosData = [];

        // =======================================================
        // 2. آليات الاتصال بالشيت (READ/WRITE)
        // =======================================================

        async function loadDataFromSheet() {
            console.log('🔄 جاري تحميل البيانات من Google Sheet API...');
            
            try {
                const response = await fetch(SHEET_API_URL, { method: 'GET' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.status === 'error') {
                    throw new Error(`API Error: ${data.message}`);
                }
                
                // تحديث البيانات المحلية ببيانات الشيت
                teachers = data.teachers.map(t => ({
                    id: Number(t.ID), 
                    name: t.Name, 
                    class: t.Class,
                    status: t.Status || 'not-recorded', 
                    timestamp: t.Timestamp || null,
                    notes: t.Notes || '',
                    // إضافة نقاط شهرية للمعلمات للمقارنة (افتراض 0 إذا لم تتوفر في الشيت)
                    monthlyPoints: Number(t.MonthlyPoints) || 0 
                }));
                classes = data.classes.map(c => ({
                    name: c.ClassName, 
                    totalPoints: Number(c.TotalPoints) || 0,
                    dailyPoints: Number(c.DailyPoints) || 0, 
                    monthlyPoints: Number(c.MonthlyPoints) || 0,
                    quiet: Number(c.Quiet) || 0, 
                    speed: Number(c.Speed) || 0,
                    volume: Number(c.Volume) || 0, 
                    cleanliness: Number(c.Cleanliness) || 0,
                    notes: c.Notes || ''
                }));
                
                // ⭐️ تحديث ملخصات النجوم والإحصائيات بعد الجلب
                updateStarSummaries();
                renderTeachers();
                renderClasses();
                updateStats();
                updateStarSelects();
                
                console.log(`✅ تم تحميل: ${teachers.length} معلمة و ${classes.length} صف.`);
                return true;

            } catch (error) {
                console.error('❌ خطأ في تحميل البيانات من API:', error);
                document.getElementById('teachersGrid').innerHTML = '<div class="glass-morphism" style="padding: 3rem; text-align: center; color: white; grid-column: 1 / -1;"><h3>❌ فشل تحميل البيانات</h3><p>يرجى التأكد من رابط API وإعدادات النشر.</p></div>';
                return false;
            }
        }

        async function syncToSheet(action, payload) {
            if (!SHEET_API_URL) return { status: 'error', message: 'API URL not set.' };

            try {
                const fullPayload = { action: action, ...payload };
                console.log(`📤 إرسال طلب ${action} إلى الشيت:`, fullPayload);

                const response = await fetch(SHEET_API_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(fullPayload)
                });
                
                return { status: 'success', message: 'Sync request sent.' }; 

            } catch (error) {
                console.error(`❌ فشل مزامنة التغيير (${action}):`, error);
                return { status: 'error', message: error.message };
            }
        }

        function loadDataFromSheets() {
            loadDataFromSheet();
        }

        // =======================================================
        // 3. الدوال الرئيسية التي تستدعي الـ Sync
        // =======================================================

        function getStatusText(status) { 
            const statusMap = { 'present': 'حاضرة', 'absent': 'غائبة', 'late': 'متأخرة', 'excused': 'بعذر', 'not-recorded': 'لم يتم التسجيل' };
            return statusMap[status] || 'لم يتم التسجيل'; 
        }

        function updatePointsWithSave(classIndex, criteria, change) {
            const classItem = classes[classIndex];
            if (!classItem) return;
            
            const currentValue = Number(classItem[criteria]) || 0; 
            const newValue = Math.max(0, currentValue + change); 
            
            // تحديث القيم في المصفوفة المحلية
            classItem[criteria] = newValue;
            classItem.totalPoints = classItem.quiet + classItem.speed + classItem.volume + classItem.cleanliness;
            classItem.dailyPoints = classItem.totalPoints; 

            renderClasses(); 
            updateStarSummaries(); 

            syncToSheet('updatePoints', { className: classItem.name, criteria: criteria, newValue: newValue });
            setTimeout(loadDataFromSheet, 1000); 
        }

        function updateAttendanceWithSave(teacherId, status) {
            const teacher = teachers.find(t => t.id === teacherId);
            if (!teacher) return;
            
            const timestamp = new Date().toLocaleString('en-US', { hour12: true }); 
            teacher.status = status;
            teacher.timestamp = timestamp;
            
            renderTeachers(); 
            updateStats();
            
            syncToSheet('updateAttendance', { 
                id: teacherId, 
                status: status, 
                notes: teacher.notes,
                timestamp: timestamp 
            });
            
            setTimeout(loadDataFromSheet, 1000); 
        }

        function resetTeacher(teacherId) {
            const teacher = teachers.find(t => t.id === teacherId);
            if (teacher && confirm(`هل تريد إعادة تعيين حضور ${teacher.name}؟`)) {
                teacher.status = 'not-recorded';
                teacher.timestamp = null; 
                
                syncToSheet('updateAttendance', { 
                    id: teacherId, 
                    status: '', 
                    notes: teacher.notes,
                    timestamp: null 
                });
                
                renderTeachers();
                updateStats();
                setTimeout(loadDataFromSheet, 1000);
                alert(`تم إعادة تعيين حضور ${teacher.name}`);
            }
        }
        
        async function resetAllAttendance() {
            if (confirm('⚠️ هل أنت متأكد من أرشفة سجل حضور اليوم وبدء يوم جديد؟\n\nستتم أرشفة الحضور الحالي ومسح جميع الحالات.')) {
                
                const response = await syncToSheet('archiveAndReset', { id: 0 }); 
                
                if (response.status === 'success') {
                    setTimeout(loadDataFromSheet, 2000); 
                    alert('✅ تم إرسال طلب أرشفة حضور اليوم بنجاح. سيتم تحديث الصفحة خلال ثوانٍ.');
                } else {
                    alert(`❌ فشل في إرسال طلب الأرشفة: ${response.message || 'خطأ غير معروف.'}\nتأكد من إعداد Apps Script بشكل صحيح.`);
                }
            }
        }

        // ⭐️ دالة تفعيل النجوم التلقائية (محدثة بالكامل)
        function updateStarSummaries() {
            // نجم اليوم: أول معلمة تسجل حضورها
            const firstPresentTeacher = teachers
                .filter(t => t.status === 'present' && t.timestamp)
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))[0];

            document.getElementById('starOfDay').textContent = firstPresentTeacher
                ? `${firstPresentTeacher.name} (${firstPresentTeacher.class})`
                : 'لم يتم الاختيار بعد';

            // نجم الشهر (معلمة): أعلى نقاط شهرية (افتراضياً)
            const topMonthlyTeacher = teachers.reduce((max, t) => (t.monthlyPoints > (max.monthlyPoints || 0) ? t : max), { monthlyPoints: -1 });
            document.getElementById('starOfMonth').textContent = (topMonthlyTeacher.monthlyPoints > 0) ? `${topMonthlyTeacher.name} (${topMonthlyTeacher.class})` : 'لم يتم الاختيار بعد';


            // نجم الطابور (يومي): الصف الأعلى نقاط يومية
            const topDailyClass = classes.reduce((max, c) => (c.dailyPoints > (max.dailyPoints || 0) ? c : max), { dailyPoints: -1 });
            document.getElementById('queueStar').textContent = (topDailyClass.dailyPoints > 0) ? topDailyClass.name : 'لم يتم الاختيار بعد';
            
             // نجم الطابور للشهر (الصف): أعلى نقاط شهرية (افتراضياً)
            const topMonthlyClass = classes.reduce((max, c) => (c.monthlyPoints > (max.monthlyPoints || 0) ? c : max), { monthlyPoints: -1 });
            document.getElementById('queueStarMonth').textContent = (topMonthlyClass.monthlyPoints > 0) ? topMonthlyClass.name : 'لم يتم الاختيار بعد';
        }
        
        // =======================================================
        // 4. الدوال المساعدة (العرض والتحقق)
        // =======================================================
        
        function updateStats() {
            const present = teachers.filter(t => t.status === 'present').length;
            const absent = teachers.filter(t => t.status === 'absent').length;
            const late = teachers.filter(t => t.status === 'late').length;
            const excused = teachers.filter(t => t.status === 'excused').length;
            const notRecorded = teachers.filter(t => t.status === 'not-recorded').length;
            document.getElementById('presentCount').textContent = present;
            document.getElementById('absentCount').textContent = absent + late + excused; 
            document.getElementById('notRecordedCount').textContent = notRecorded;
            document.getElementById('totalCount').textContent = teachers.length;
            const recordedTeachers = teachers.filter(t => t.status !== 'not-recorded' && t.timestamp);
            const log = document.getElementById('attendanceLog');
            log.innerHTML = recordedTeachers.length === 0 ? 'لا توجد تسجيلات حضور اليوم' : recordedTeachers.map(teacher => `<div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 8px;">${teacher.name} - ${getStatusText(teacher.status)} - ${teacher.timestamp.split(',')[1].trim()}</div>`).join('');
        }
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('ar-SA', options);
        }

        function renderTeachers() { 
            const grid = document.getElementById('teachersGrid');
            if (!grid) return;
            
            grid.innerHTML = teachers.map(teacher => {
                const statusClass = `status-${teacher.status}`;

                return `
                    <div class="teacher-card glass-morphism ${statusClass}" data-id="${teacher.id}">
                        ${teacher.notes ? '<div class="notes-indicator">ملاحظات</div>' : ''}
                        <div class="teacher-avatar">${teacher.name.charAt(0)}</div>
                        <div class="teacher-name">${teacher.name}</div>
                        <div class="teacher-class">${teacher.class}</div>
                        <div class="attendance-status">
                            <button class="status-btn present ${teacher.status === 'present' ? 'active' : ''}" 
                                        onclick="updateAttendanceWithSave(${teacher.id}, 'present')">حاضرة</button>
                            <button class="status-btn absent ${teacher.status === 'absent' ? 'active' : ''}" 
                                        onclick="updateAttendanceWithSave(${teacher.id}, 'absent')">غائبة</button>
                            <button class="status-btn late ${teacher.status === 'late' ? 'active' : ''}" 
                                        onclick="updateAttendanceWithSave(${teacher.id}, 'late')">متأخرة</button>
                            <button class="status-btn excused ${teacher.status === 'excused' ? 'active' : ''}" 
                                        onclick="updateAttendanceWithSave(${teacher.id}, 'excused')">بعذر</button>
                        </div>
                        <div style="text-align: center; color: white; font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <strong>الحالة:</strong> ${getStatusText(teacher.status)} 
                            ${teacher.timestamp ? `(${teacher.timestamp.split(',')[1].trim()})` : ''}
                        </div>
                        <div class="teacher-actions">
                            <button class="action-btn" onclick="openTeacherModal(${teacher.id})">
                                ✏️ تعديل
                            </button>
                            <button class="action-btn" onclick="resetTeacher(${teacher.id})">
                                🔄 إعادة تعيين
                            </button>
                            <button class="action-btn" onclick="openCameraModal(${teacher.id}, '${teacher.name}', '${teacher.class}')">
                                📸 صورة
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('teachersGrid').innerHTML = teachers.length === 0 ? '<div class="glass-morphism loading" style="padding: 3rem; text-align: center; color: white; grid-column: 1 / -1;">لا توجد بيانات معلمات للتحميل.</div>' : grid.innerHTML;
        }

        function renderClasses() { 
            const grid = document.getElementById('classesGrid');
            if (!grid) return;

            const topDailyClass = classes.reduce((max, current) => 
                current.dailyPoints > max.dailyPoints ? current : max, { dailyPoints: -1 }
            );

            grid.innerHTML = classes.map((classItem, index) => {
                const winnerClass = (classItem.name === topDailyClass.name && topDailyClass.dailyPoints > 0) ? 'queue-star-winner' : '';

                return `
                    <div class="class-card glass-morphism ${winnerClass}" onclick="openClassModal(${index})" style="cursor: pointer;">
                        <div class="class-name">${classItem.name}</div>
                        <div class="class-points">
                            ${classItem.dailyPoints} 
                            <span style="font-size: 1rem; opacity: 0.8;">(إجمالي اليوم: ${classItem.totalPoints})</span>
                        </div>
                        <div style="text-align: center; color: white; margin-bottom: 1.5rem;">
                            نقاط الشهر: <strong>${classItem.monthlyPoints}</strong>
                        </div>
                        <div class="criteria-controls">
                            ${renderCriteriaRow(index, 'quiet', 'الهدوء')}
                            ${renderCriteriaRow(index, 'speed', 'السرعة')}
                            ${renderCriteriaRow(index, 'volume', 'الصوت')}
                            ${renderCriteriaRow(index, 'cleanliness', 'النظافة')}
                        </div>
                        <div style="text-align: center; margin-top: 1.5rem;">
                             <button class="nav-button" style="background: #2196f3;" onclick="event.stopPropagation(); openClassModal(${index});">
                                ✏️ تعديل الصف
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('classesGrid').innerHTML = classes.length === 0 ? '<div class="glass-morphism loading" style="padding: 3rem; text-align: center; color: white; grid-column: 1 / -1;">لا توجد بيانات صفوف للتحميل.</div>' : grid.innerHTML;
        }

        function renderCriteriaRow(classIndex, criteria, name) {
            const classItem = classes[classIndex];
            const points = classItem[criteria] || 0;
            return `
                <div class="criteria-row">
                    <div class="criteria-name">${name}</div>
                    <div class="criteria-controls-btn">
                        <button class="point-btn minus" onclick="event.stopPropagation(); updatePointsWithSave(${classIndex}, '${criteria}', -1)">-</button>
                        <div class="criteria-points">${points}</div>
                        <button class="point-btn plus" onclick="event.stopPropagation(); updatePointsWithSave(${classIndex}, '${criteria}', 1)">+</button>
                    </div>
                </div>
            `;
        }
        function updateStarSelects() { 
             const teacherSelects = ['starOfDaySelect', 'starOfMonthSelect'];
             const classSelects = ['queueStarSelect', 'queueStarMonthSelect'];

             teacherSelects.forEach(selectId => {
                 const select = document.getElementById(selectId);
                 if (select) {
                     select.innerHTML = '<option value="">اختر المعلمة</option>' +
                         teachers.map(t => `<option value="${t.name} (${t.class})">${t.name} (${t.class})</option>`).join('');
                     
                     if (selectId === 'starOfMonthSelect' && document.getElementById('starOfMonth').textContent !== 'لم يتم الاختيار بعد') {
                         select.value = document.getElementById('starOfMonth').textContent;
                     }
                 }
             });

             classSelects.forEach(selectId => {
                 const select = document.getElementById(selectId);
                 if (select) {
                     select.innerHTML = '<option value="">اختر الصف</option>' +
                         classes.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                     
                     if (selectId === 'queueStarMonthSelect' && document.getElementById('queueStarMonth').textContent !== 'لم يتم الاختيار بعد') {
                         select.value = document.getElementById('queueStarMonth').textContent;
                     }
                 }
             });
        }
        function updateDataManagement() { 
            const infoDiv = document.getElementById('dataManagementInfo');
            if (infoDiv) {
                infoDiv.innerHTML = `
                    <p>عدد المعلمات المحملة: <strong>${teachers.length}</strong></p>
                    <p>عدد الصفوف المحملة: <strong>${classes.length}</strong></p>
                    <p>آخر تحديث من الشيت: <strong>${new Date().toLocaleTimeString()}</strong></p>
                `;
            }
        }
        function renderTeachersManagementList() {
            const list = document.getElementById('teachersManagementList');
            if (!list) return;

            list.innerHTML = `
                <div style="font-weight: bold; display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 2px solid rgba(255,255,255,0.3); color: white;">
                    <span>الاسم (ID)</span>
                    <span>الصف</span>
                    <span>الإجراءات</span>
                </div>
                ${teachers.map(t => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px dashed rgba(255,255,255,0.1); color: white;">
                        <span>${t.name} (ID: ${t.id})</span>
                        <span>${t.class}</span>
                        <div>
                            <button class="action-btn" onclick="openTeacherModal(${t.id})" style="background: #2196f3;">✏️</button>
                            <button class="action-btn" onclick="deleteTeacher(${t.id})" style="background: #f44336;">🗑️</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        function checkSystemPassword() {
            const input = document.getElementById('systemPassword');
            if (input.value === systemPassword) {
                document.getElementById('passwordPrompt').style.display = 'none';
                document.getElementById('systemContent').style.display = 'block';
                renderTeachersManagementList();
                updateStarSelects();
                updateDataManagement();
                document.getElementById('motivationalText').value = motivationalQuote; 
            } else {
                alert('كلمة المرور غير صحيحة');
                input.value = '';
            }
        }
        function updateSystemPassword() {
            const newPass = document.getElementById('newSystemPassword').value;
            if (newPass.length > 0) {
                systemPassword = newPass;
                alert('✅ تم تحديث كلمة مرور النظام بنجاح!');
                document.getElementById('newSystemPassword').value = '';
            } else {
                alert('❌ يرجى إدخال كلمة مرور جديدة.');
            }
        }
        function updateMotivationalText() {
             const newText = document.getElementById('motivationalText').value;
            if (newText.length > 0) {
                motivationalQuote = newText;
                document.getElementById('motivationalSubtitle').textContent = newText;
                alert('✅ تم تحديث العبارة التحفيزية بنجاح!');
            } else {
                alert('❌ يرجى إدخال عبارة تحفيزية.');
            }
        }
        function showAddTeacherForm() {
            document.getElementById('addTeacherForm').classList.add('active');
        }
        function hideAddTeacherForm() {
            document.getElementById('addTeacherForm').classList.remove('active');
        }
        function addNewTeacher() {
            const name = document.getElementById('newTeacherName').value.trim();
            const className = document.getElementById('newTeacherClass').value.trim();

            if (!name || !className) {
                alert('يرجى إدخال اسم المعلمة والصف.');
                return;
            }
            alert('🚫 تنبيه: تم إضافة المعلمة محلياً فقط. للحصول على ID صحيح ومزامنة دائمة، يرجى إضافتها في Google Sheet.');

            const newId = Math.max(...teachers.map(t => t.id), 0) + 1;
            const newTeacher = {
                id: newId,
                name: name,
                class: className,
                status: 'not-recorded',
                timestamp: null,
                notes: '',
                monthlyPoints: 0 // نقطة شهرية افتراضية
            };
            teachers.push(newTeacher);
            renderTeachers();
            renderTeachersManagementList();
            updateStats();
            updateStarSelects();
            updateDataManagement();
            
            syncToSheet('addTeacher', newTeacher);

            document.getElementById('newTeacherName').value = '';
            document.getElementById('newTeacherClass').value = '';
            hideAddTeacherForm();
        }
        function deleteTeacher(teacherId) { 
            if (confirm('هل أنت متأكد من حذف هذه المعلمة؟ سيتم حذفها محلياً فقط. للحذف الدائم، يجب حذفها من Google Sheet.')) {
                teachers = teachers.filter(t => t.id !== teacherId);
                renderTeachers();
                renderTeachersManagementList();
                updateStats();
                updateStarSummaries(); // تحديث النجوم بعد الحذف
                updateStarSelects();
                updateDataManagement();
                syncToSheet('deleteTeacher', { id: teacherId });
                alert('✅ تم حذف المعلمة محلياً. يرجى حذفها من Google Sheet أيضاً.');
            }
        }
        function saveTeacherChanges() {
            const teacher = teachers.find(t => t.id === currentEditingTeacherId);
            if (!teacher) return;

            teacher.name = document.getElementById('editTeacherName').value.trim();
            teacher.class = document.getElementById('editTeacherClass').value.trim();
            teacher.notes = document.getElementById('editTeacherNotes').value.trim();

            renderTeachers();
            renderTeachersManagementList();
            updateStarSelects();
            closeTeacherModal();

            syncToSheet('updateTeacher', { 
                id: teacher.id, 
                name: teacher.name, 
                class: teacher.class, 
                notes: teacher.notes 
            });
            alert('✅ تم حفظ التغييرات. يرجى المزامنة مع الشيت للتأكد من تحديث الاسم والصف بشكل دائم.');
        }
        function saveClassChanges() {
            const classItem = classes[currentEditingClassIndex];
            if (!classItem) return;

            classItem.name = document.getElementById('editClassName').value.trim();
            classItem.notes = document.getElementById('editClassNotes').value.trim();

            renderClasses();
            closeClassModal();

            syncToSheet('updateClass', { 
                className: classItem.name, 
                notes: classItem.notes 
            });
            alert('✅ تم حفظ تغييرات الصف.');
        }
        function addAllDailyToMonthly() {
             if (!confirm('هل أنت متأكد من إضافة نقاط اليوم إلى نقاط الشهر لجميع الصفوف؟')) return;

            classes.forEach(c => {
                c.monthlyPoints += c.dailyPoints;
            });
            renderClasses();
            updateStarSummaries();

            syncToSheet('addAllDailyToMonthly', { id: 0 });
            setTimeout(loadDataFromSheet, 2000);
            alert('✅ تم إضافة نقاط اليوم إلى الشهر. سيتم تحديث الصفحة قريباً.');
        }

        function resetAllDailyPoints() {
            if (!confirm('هل أنت متأكد من تصفير جميع نقاط اليوم (الهدوء، السرعة، الصوت، النظافة، الإجمالي) لجميع الصفوف؟')) return;

            classes.forEach(c => {
                c.dailyPoints = 0;
                c.totalPoints = 0;
                c.quiet = 0;
                c.speed = 0;
                c.volume = 0;
                c.cleanliness = 0;
            });
            renderClasses();
            updateStarSummaries();

            syncToSheet('resetAllDailyPoints', { id: 0 });
            setTimeout(loadDataFromSheet, 2000);
            alert('✅ تم تصفير جميع نقاط اليوم. سيتم تحديث الصفحة قريباً.');
        }

        function resetAllMonthlyPoints() {
            if (!confirm('⚠️ هل أنت متأكد من تصفير جميع نقاط الشهر لجميع الصفوف؟ لا يمكن التراجع عن هذا الإجراء.')) return;
            
            classes.forEach(c => {
                c.monthlyPoints = 0;
            });
            renderClasses();
            updateStarSummaries();
            
            syncToSheet('resetAllMonthlyPoints', { id: 0 });
            setTimeout(loadDataFromSheet, 2000);
            alert('✅ تم تصفير جميع نقاط الشهر. سيتم تحديث الصفحة قريباً.');
        }

        function resetAllPoints() {
            if (!confirm('⚠️ هل أنت متأكد من تصفير جميع النقاط (اليوم والشهر) لجميع الصفوف؟ لا يمكن التراجع عن هذا الإجراء.')) return;
            
            classes.forEach(c => {
                c.dailyPoints = 0;
                c.totalPoints = 0;
                c.monthlyPoints = 0;
                c.quiet = 0;
                c.speed = 0;
                c.volume = 0;
                c.cleanliness = 0;
            });
            renderClasses();
            updateStarSummaries();
            
            syncToSheet('resetAllPoints', { id: 0 });
            setTimeout(loadDataFromSheet, 2000);
            alert('✅ تم تصفير جميع النقاط. سيتم تحديث الصفحة قريباً.');
        }
        
        function updateDailyStars() {
            updateStarSummaries(); 
            alert('✅ تم تحديث ملخص النجوم اليومية بناءً على البيانات الحالية.');
        }

        function updateMonthlyStars() {
            const starOfMonth = document.getElementById('starOfMonthSelect').value;
            const queueStarMonth = document.getElementById('queueStarMonthSelect').value;

            document.getElementById('starOfMonth').textContent = starOfMonth || 'لم يتم الاختيار بعد';
            document.getElementById('queueStarMonth').textContent = queueStarMonth || 'لم يتم الاختيار بعد';

            syncToSheet('updateMonthlyStars', { starOfMonth: starOfMonth, queueStarMonth: queueStarMonth });
            alert('✅ تم تحديث نجوم الشهر بنجاح.');
        }

        // ===================================================
        // 5. وظائف الشهادات (المدمجة والمنقحة)
        // ===================================================

        // ⭐️ دالة لحفظ الشهادة كـ PDF (تم دمجها من التحديث الأخير)
        async function saveCertificatePDF(containerId, fileName) {
            const container = document.getElementById(containerId);
            if (!container) {
                alert('❌ لم يتم العثور على عنصر الشهادة.');
                return;
            }

            // التأكد من تحميل أي صور
            const images = container.querySelectorAll('img');
            await Promise.all(Array.from(images).map(img => {
                if (img.complete) return Promise.resolve();
                return new Promise(resolve => { img.onload = img.onerror = resolve; });
            }));

            try {
                // إنشاء canvas
                const canvas = await html2canvas(container, {
                    scale: 2,
                    useCORS: true, 
                    scrollY: -window.scrollY,
                    logging: true
                });
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(fileName);
                alert('✅ تم حفظ الشهادة بنجاح');
            } catch (err) {
                console.error(err);
                alert('❌ حدث خطأ أثناء حفظ الشهادة');
            }
        }


        // ⭐️ دالة مُعدّلة لإنشاء الشهادة في الذاكرة مع المعاينة والحفظ الفوري
        async function generateCertificatePreview({ name, icon, isClass = false, starType = 'شكر وتقدير' }) {
            // إزالة أي شهادة موجودة سابقة
            const existing = document.getElementById('certificatePreview');
            if (existing) existing.remove();

            const date = new Date().toLocaleDateString('ar-SA', { year: 'numeric', month: 'long', day: 'numeric' });
            
            // 1. إنشاء العنصر المؤقت (للعرض والحفظ)
            const certificateContainer = document.createElement('div');
            certificateContainer.id = 'certificatePreview';
            certificateContainer.style.width = '800px';
            certificateContainer.style.padding = '3rem';
            certificateContainer.style.background = 'white';
            certificateContainer.style.textAlign = 'center';
            certificateContainer.style.border = '1px solid #ccc';
            certificateContainer.style.position = 'relative';
            certificateContainer.style.margin = '2rem auto'; 
            certificateContainer.style.fontFamily = 'Tajawal, sans-serif';
            certificateContainer.style.direction = 'rtl';
            certificateContainer.style.color = '#333';
            
            const headerLogoHtml = document.querySelector('#siteHeaderLogo')?.outerHTML || '';
            
            let certificateText = '';
            if (isClass) {
                certificateText = `تقديراً لانضباطه وأدائه المتميز كنجم الطابور المدرسي`;
            } else {
                certificateText = `تقديراً لجهودها وأدائها المتميز كـ ${starType}`;
            }
            
            // بناء محتوى الشهادة
            const certificateContentHTML = `
                <div class="certificate-header">${headerLogoHtml}</div>
                <h2 style="margin: 1rem 0; color: #ab47bc;">شهادة ${starType}</h2>
                <h3>تمنح ${isClass ? 'لصف' : 'للمعلمة'}: <strong style="color: #ff6b9d;">${name}</strong></h3>
                <p style="font-size: 1.2rem;">${certificateText}</p>
                <div style="font-size: 3rem; margin: 1rem 0;">${icon || '🌟'}</div>
                <p style="margin-top: 2rem;">المدرسة: أم مالك الأنصارية للبنات</p>
                <p style="margin-top: 3rem; font-weight: bold;">مديرة المدرسة</p>
                <p style="font-size: 0.9rem; color: #666;">حررت في: ${date}</p>
            `;

            certificateContainer.innerHTML = certificateContentHTML;
            document.body.appendChild(certificateContainer); 

            // 2. معاينة الشهادة في الواجهة
            const previewContainer = document.getElementById('certificatePreviewContainer');
            if (previewContainer) {
                // عرض المحتوى في منطقة المعاينة (بدون زر الحفظ الذي سيُضاف لاحقاً)
                previewContainer.innerHTML = certificateContentHTML; 
                
                // إضافة زر الحفظ وربطه بالدالة الجديدة
                 previewContainer.innerHTML += `<div style="margin-top:1rem;"><button id="exportCertificateBtn" class="nav-button" style="background: #28a745;">📥 حفظ PDF الآن</button></div>`;
                
                document.getElementById('certificatePlaceholder').style.display = 'none';

                 // ربط زر الحفظ بالدالة الجديدة
                document.getElementById('exportCertificateBtn').onclick = () => {
                    const fileName = `${name}_${starType.replace(/\s/g, '_')}_${date}.pdf`;
                    // نستخدم ID العنصر المؤقت الذي أنشأناه في الـ body
                    saveCertificatePDF('certificatePreview', fileName); 
                };
            }
            
            // 3. إزالة الشهادة المؤقتة من الـ body بعد 3 ثوانٍ (لتجنب تراكم العناصر)
             setTimeout(() => {
                 if (document.getElementById('certificatePreview')) {
                     document.getElementById('certificatePreview').remove();
                 }
             }, 3000);
            
            return certificateContainer;
        }

        // ⭐️ دالة موحدة لإنشاء الشهادة بناءً على النوع
        function createStarCertificate(type) {
             let name, icon, isClass, starType;

             if (type === 'dailyClass') {
                 const topDailyClass = classes.reduce((max, c) => (c.dailyPoints > (max.dailyPoints || 0) ? c : max), {});
                 if (!topDailyClass.name || topDailyClass.dailyPoints <= 0) return alert('لا يوجد صف مؤهل لنجم الطابور اليوم.');
                 name = topDailyClass.name;
                 icon = '⭐';
                 isClass = true;
                 starType = 'نجم الطابور اليومي';
             } else if (type === 'starOfDay') {
                 const firstPresentTeacher = teachers
                     .filter(t => t.status === 'present' && t.timestamp)
                     .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))[0];
                 if (!firstPresentTeacher) return alert('لا يوجد معلمة مؤهلة لنجم اليوم (يجب أن تسجل حضورها أولاً).');
                 name = firstPresentTeacher.name;
                 icon = '🌟';
                 isClass = false;
                 starType = 'نجمة اليوم';
             } else if (type === 'starOfMonth') {
                 const selectedStar = document.getElementById('starOfMonthSelect').value;
                 if (selectedStar === '' || selectedStar === 'لم يتم الاختيار بعد') return alert('يرجى اختيار نجمة الشهر من قائمة "إدارة النجوم" أولاً.');
                 name = selectedStar.substring(0, selectedStar.indexOf('(')).trim();
                 icon = '🏆';
                 isClass = false;
                 starType = 'نجمة الشهر';
             } else if (type === 'queueStarMonth') {
                 const selectedStar = document.getElementById('queueStarMonthSelect').value;
                 if (selectedStar === '' || selectedStar === 'لم يتم الاختيار بعد') return alert('يرجى اختيار نجم الطابور للشهر من قائمة "إدارة النجوم" أولاً.');
                 name = selectedStar;
                 icon = '👑';
                 isClass = true;
                 starType = 'نجم الطابور للشهر';
             } else if (type === 'attendance') {
                 name = 'جميع المعلمات المتميزات';
                 icon = '📋';
                 isClass = false;
                 starType = 'تقدير للحضور المميز';
             } else {
                 return alert('نوع الشهادة غير صحيح.');
             }
             
             generateCertificatePreview({ name, icon, isClass, starType });
        }
        
        // دالة الطباعة بالمتصفح (للتراجع في حال لم يُرضي التصدير المباشر)
        function printCertificate() {
             alert('يرجى اختيار نوع الشهادة أولاً. سيتم تصديرها كـ PDF مباشرة بمجرد الاختيار.');
        }

        // ===================================================
        // 6. وظائف التقارير (لم تتغير)
        // ===================================================
        
        // ⭐️ دالة موحدة لتوليد وعرض وتصدير تقارير النجوم (محدثة للتصدير المباشر)
        function generateAndExportStarsReport(format, type = 'daily') {
            const reportData = classes.map(c => ({
                'الصف': c.name,
                'نقاط الهدوء': c.quiet,
                'نقاط السرعة': c.speed,
                'نقاط الصوت': c.volume,
                'نقاط النظافة': c.cleanliness,
                'إجمالي اليوم': c.dailyPoints,
                'إجمالي الشهر': c.monthlyPoints,
                'ملاحظات': c.notes
            }));
            
            const reportTitle = `تقرير نجوم الطابور (${type === 'daily' ? 'يومي' : type === 'weekly' ? 'أسبوعي' : 'شهري'})`;
            const fileName = `QueueStars_${type}_Report_${new Date().toLocaleDateString('en-US').replace(/\//g, '-')}`;
            
            displayReport(reportData, reportTitle, 'stars');
            
            if (format !== 'display') exportReportByFormat(format, reportData, reportTitle, fileName);
        }
        
        // ⭐️ دالة موحدة لتوليد وعرض وتصدير تقارير الحضور (محدثة للتصدير المباشر)
        function generateAndExportAttendanceReport(format, type = 'daily') {
            const reportData = teachers.map(t => ({
                'ID': t.id,
                'الاسم': t.name,
                'الصف': t.class,
                'حالة الحضور': getStatusText(t.status),
                'وقت التسجيل': t.timestamp || 'لا يوجد',
                'ملاحظات': t.notes
            }));
            
            const reportTitle = `تقرير حضور المعلمات (${type === 'daily' ? 'يومي' : type === 'weekly' ? 'أسبوعي' : 'شهري'})`;
            const fileName = `Attendance_${type}_Report_${new Date().toLocaleDateString('en-US').replace(/\//g, '-')}`;

            displayReport(reportData, reportTitle, 'attendance');
            
            if (format !== 'display') exportReportByFormat(format, reportData, reportTitle, fileName);
        }

        async function exportReportByFormat(format, data, title, fileName) {
            const reportEl = document.getElementById('reportToExport');
            displayReport(data, title, 'export'); 
            
            if (format === 'excel') {
                 exportToExcel(data, fileName);
            } else if (format === 'pdf') {
                 await exportToPDF('reportToExport', fileName);
            } else if (format === 'image') {
                 await exportToImage('reportToExport', fileName);
            }
        }
        
        function generateAndExportDailyAttendance(format) { generateAndExportAttendanceReport(format, 'daily'); }
        function generateAndExportWeeklyAttendance(format) { generateAndExportAttendanceReport(format, 'weekly'); alert('عرض التقرير الأسبوعي يستخدم حالياً بيانات اليوم.'); }
        function generateAndExportMonthlyAttendance(format) { generateAndExportAttendanceReport(format, 'monthly'); alert('عرض التقرير الشهري يستخدم حالياً بيانات اليوم.'); }

        function generateAndExportDailyStars(format) { generateAndExportStarsReport(format, 'daily'); }
        function generateAndExportWeeklyStars(format) { generateAndExportStarsReport(format, 'weekly'); alert('عرض التقرير الأسبوعي يستخدم حالياً بيانات اليوم.'); }
        function generateAndExportMonthlyStars(format) { generateAndExportStarsReport(format, 'monthly'); alert('عرض التقرير الشهري يستخدم حالياً بيانات اليوم.'); }
        
        function exportCompleteReport(format) {
             const allData = {
                'Attendance': teachers.map(t => ({
                    'ID': t.id,
                    'الاسم': t.name,
                    'الصف': t.class,
                    'حالة الحضور': getStatusText(t.status),
                    'وقت التسجيل': t.timestamp || 'لا يوجد',
                    'ملاحظات': t.notes
                })),
                'QueueStars': classes.map(c => ({
                    'الصف': c.name,
                    'نقاط اليوم': c.dailyPoints,
                    'نقاط الشهر': c.monthlyPoints,
                    'نقاط الهدوء': c.quiet,
                    'نقاط السرعة': c.speed,
                    'نقاط الصوت': c.volume,
                    'نقاط النظافة': c.cleanliness,
                    'ملاحظات': c.notes
                }))
            };
            const reportTitle = `التقرير الشامل - ${new Date().toLocaleDateString('ar-SA')}`;
            const fileName = `Comprehensive_Report_${new Date().toLocaleDateString('en-US').replace(/\//g, '-')}`;
            
            if (format === 'excel') {
                exportMultipleSheetsToExcel(allData, fileName);
            } else {
                alert('لا يمكن عرض التقرير الشامل (PDF/Image) على شكل معاينة. سيتم تصدير نسخة Excel فقط.');
            }
        }

        function displayReport(data, title, type) {
            const previewContainer = document.getElementById('reportPreviewContainer');
            const preview = document.getElementById('reportToExport');
            document.getElementById('reportPlaceholder').style.display = 'none';

            let tableHtml = `<div class="report-preview-container" style="padding: 2rem; border-radius: 15px; background: #fff; color: #333; text-align: right;">
                <div class="report-header">
                    <h2 class="report-title">${title}</h2>
                    <p class="report-date">تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>
                </div>
                <table border="1" id="reportTable" style="width:100%; border-collapse:collapse; text-align:center; font-size: 0.9rem;">
                    <thead><tr>`;
            
            const headers = Object.keys(data[0] || {});
            headers.forEach(header => {
                tableHtml += `<th style="padding: 0.5rem; background: #ab47bc; color: white;">${header}</th>`;
            });
            tableHtml += `</tr></thead><tbody>`;

            data.forEach(row => {
                tableHtml += `<tr>`;
                headers.forEach(header => {
                    tableHtml += `<td style="padding: 0.5rem;">${row[header]}</td>`;
                });
                tableHtml += `</tr>`;
            });

            tableHtml += `</tbody></table></div>`;
            
            preview.innerHTML = tableHtml;
            preview.style.display = 'block';
            previewContainer.scrollTop = 0; 
        }

        function exportToExcel(data, fileName) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'البيانات');
            XLSX.writeFile(wb, `${fileName}.xlsx`);
            alert(`✅ تم تصدير ${fileName}.xlsx بنجاح.`);
        }
        
        function exportMultipleSheetsToExcel(data, fileName) {
             const wb = XLSX.utils.book_new();
             for (const sheetName in data) {
                 const ws = XLSX.utils.json_to_sheet(data[sheetName]);
                 XLSX.utils.book_append_sheet(wb, ws, sheetName);
             }
             XLSX.writeFile(wb, `${fileName}.xlsx`);
             alert(`✅ تم تصدير ${fileName}.xlsx بصفحات متعددة بنجاح.`);
        }

        async function exportToPDF(elementId, fileName) {
            const element = document.getElementById(elementId);
             if (!element || element.style.display === 'none') {
                 alert('❌ يرجى عرض التقرير أولاً في المعاينة قبل التصدير.');
                 return;
             }
            await new Promise(resolve => setTimeout(resolve, 200)); 

            html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 200; 
                const pageHeight = 290;
                const imgHeight = canvas.height * imgWidth / canvas.width;

                pdf.addImage(imgData, 'PNG', 5, 5, imgWidth, imgHeight);
                pdf.save(`${fileName}.pdf`);
                alert(`✅ تم تصدير ${fileName}.pdf بنجاح.`);
            }).catch(error => {
                console.error("Error generating PDF:", error);
                alert("❌ فشل في إنشاء ملف PDF. يرجى مراجعة الكونسول.");
            });
        }
        
        async function exportToImage(elementId, fileName) {
            const element = document.getElementById(elementId);
            if (!element || element.style.display === 'none') {
                 alert('❌ يرجى عرض التقرير أولاً في المعاينة قبل التصدير.');
                 return;
            }
             await new Promise(resolve => setTimeout(resolve, 200)); 

            html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                canvas.toBlob(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${fileName}.png`;
                    link.click();
                    alert(`✅ تم تصدير ${fileName}.png بنجاح.`);
                }, 'image/png');
            });
        }

        function printReport() {
            const preview = document.getElementById('reportToExport');
             if (preview.style.display === 'none') {
                alert('يرجى اختيار نوع التقرير لمعاينته أولاً.');
                return;
            }
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>طباعة التقرير</title><style>.report-preview-container{ padding: 2rem; border-radius: 15px; background: #fff; color: #333; text-align: right; } table, th, td { border: 1px solid #ddd; border-collapse: collapse; padding: 8px; text-align: right; } th { background: #ab47bc; color: white; }</style></head><body style="direction:rtl; font-family: \'Tajawal\', sans-serif;">');
            printWindow.document.write(preview.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        // ===================================================
        // 7. وظائف النسخ الاحتياطي والكاميرا (لم تتغير)
        // ===================================================
        function exportSavedData() {
            const dataToExport = {
                teachers: teachers,
                classes: classes,
                systemPassword: systemPassword,
                motivationalQuote: motivationalQuote
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `QueueSystem_Backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('✅ تم تصدير النسخة الاحتياطية بنجاح.');
        }

        function importSavedData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!confirm('⚠️ هل أنت متأكد من استيراد البيانات؟ هذا سيحل محل البيانات الحالية. لن يؤثر على بيانات Google Sheet حتى تقوم بالمزامنة يدوياً.')) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        teachers = importedData.teachers || [];
                        classes = importedData.classes || [];
                        systemPassword = importedData.systemPassword || 'admin123';
                        motivationalQuote = importedData.motivationalQuote || 'انضباط يعكس وعيًا ونظام يصنع الأجيال';

                        renderTeachers();
                        renderClasses();
                        updateStats();
                        updateStarSummaries();
                        renderTeachersManagementList();
                        updateDataManagement();
                        document.getElementById('motivationalSubtitle').textContent = motivationalQuote;
                        document.getElementById('motivationalText').value = motivationalQuote;
                        
                        alert('✅ تم استيراد البيانات المحلية بنجاح! يرجى تحديث البيانات من الشيت إذا كنت تريد استعادة البيانات السحابية.');
                    } catch (error) {
                        alert(`❌ فشل في تحليل ملف JSON: ${error.message}`);
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllSavedData() {
            if (confirm('⚠️ هل أنت متأكد من مسح جميع البيانات المحلية (المعلمات، الصفوف، النقاط، الإعدادات)؟ هذا لن يؤثر على بيانات Google Sheet، ويمكنك استعادتها منه لاحقاً.')) {
                teachers = [];
                classes = [];
                systemPassword = 'admin123';
                motivationalQuote = 'انضباط يعكس وعيًا ونظام يصنع الأجيال';
                
                renderTeachers();
                renderClasses();
                updateStats();
                updateStarSummaries();
                renderTeachersManagementList();
                updateDataManagement();
                document.getElementById('motivationalSubtitle').textContent = motivationalQuote;
                document.getElementById('motivationalText').value = motivationalQuote;
                
                alert('✅ تم مسح جميع البيانات المحلية. يرجى تحديث البيانات من الشيت لاستعادة البيانات السحابية.');
            }
        }
        
        function openCameraModal(teacherId, teacherName, className) {
            currentCameraTeacherId = teacherId;
            document.getElementById('overlayTeacherName').textContent = teacherName;
            document.getElementById('overlayClassName').textContent = className;
            document.getElementById('cameraModal').classList.add('active');
            updateCameraDateTime();
            
            startCamera();
        }

        function closeCameraModal() {
            stopCamera();
            document.getElementById('cameraModal').classList.remove('active');
            currentCameraTeacherId = null;
        }

        function updateCameraDateTime() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('overlayDateTime').textContent = now.toLocaleDateString('ar-SA', options);
        }

        async function getAvailableCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(device => device.kind === 'videoinput');
                console.log('Available cameras:', availableCameras);
            } catch (error) {
                console.error('Error enumerating devices:', error);
                availableCameras = [];
            }
        }

        async function startCamera(deviceId = null) {
            const video = document.getElementById('cameraVideo');
            const statusDiv = document.getElementById('cameraStatus');
            
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'جاري التشغيل...';
            
            if (!availableCameras.length) await getAvailableCameras();

            if (!availableCameras.length) {
                statusDiv.innerHTML = '<span style="color: red;">❌ لم يتم العثور على كاميرات. تأكد من السماح بالوصول.</span>';
                return;
            }

            const constraint = deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' }; 

            try {
                if (cameraStream) stopCamera();
                
                const constraints = {
                    video: constraint
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = cameraStream;
                video.onloadedmetadata = () => {
                    video.play();
                    statusDiv.innerHTML = '<span style="color: green;">✅ الكاميرا قيد التشغيل.</span>';
                    document.getElementById('startCameraBtn').style.display = 'none';
                    document.getElementById('captureBtn').style.display = 'inline-flex';
                    document.getElementById('switchCameraBtn').style.display = availableCameras.length > 1 ? 'inline-flex' : 'none';
                    document.getElementById('stopCameraBtn').style.display = 'inline-flex';
                    
                    const currentTrack = cameraStream.getVideoTracks()[0];
                    const currentCamIndex = availableCameras.findIndex(d => d.deviceId === currentTrack.getSettings().deviceId);
                    currentCameraIndex = currentCamIndex !== -1 ? currentCamIndex : 0;
                };

                setInterval(updateCameraDateTime, 1000); 
            } catch (error) {
                console.error('Error starting camera:', error);
                statusDiv.innerHTML = '<span style="color: red;">❌ خطأ في الوصول للكاميرا. تأكد من السماح بالوصول.</span>';
                document.getElementById('startCameraBtn').style.display = 'inline-flex';
                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('switchCameraBtn').style.display = 'none';
                document.getElementById('stopCameraBtn').style.display = 'none';
            }
        }
        
        function switchCamera() {
            if (availableCameras.length <= 1) {
                alert('لا توجد كاميرات أخرى للتبديل إليها.');
                return;
            }
            
            stopCamera(); 
            
            currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
            const nextCameraId = availableCameras[currentCameraIndex].deviceId;
            
            startCamera(nextCameraId); 
        }

        function stopCamera() {
            const video = document.getElementById('cameraVideo');
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                cameraStream = null;
                document.getElementById('cameraStatus').innerHTML = 'الكاميرا متوقفة.';
                document.getElementById('startCameraBtn').style.display = 'inline-flex';
                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('switchCameraBtn').style.display = 'none';
                document.getElementById('stopCameraBtn').style.display = 'none';
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const overlay = document.getElementById('photoOverlay');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // إضافة الـ Overlay كنص على الصورة
            ctx.font = "24px 'Tajawal', sans-serif";
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)'; 
            ctx.fillRect(10, canvas.height - 100, canvas.width - 20, 80); 
            
            ctx.fillStyle = 'white';
            ctx.textAlign = 'right';
            const teacherName = document.getElementById('overlayTeacherName').textContent;
            const className = document.getElementById('overlayClassName').textContent;
            const dateTime = document.getElementById('overlayDateTime').textContent;
            
            ctx.fillText(teacherName, canvas.width - 20, canvas.height - 75);
            ctx.font = "20px 'Tajawal', sans-serif";
            ctx.fillText(className, canvas.width - 20, canvas.height - 50);
            ctx.font = "16px 'Tajawal', sans-serif";
            ctx.fillText(dateTime, canvas.width - 20, canvas.height - 25);


            const imageDataURL = canvas.toDataURL('image/png');
            
            // حفظ الصورة
            const photoName = `${document.getElementById('overlayTeacherName').textContent}_${new Date().getTime()}.png`;
            capturedPhotosData.push({ dataURL: imageDataURL, name: photoName });
            
            displayCapturedPhotos();
            document.getElementById('cameraStatus').innerHTML = `<span style="color: #ff6b9d;">📸 تم التقاط وحفظ صورة ${photoName}.</span>`;
        }

        function displayCapturedPhotos() {
            const grid = document.getElementById('photosGrid');
            grid.innerHTML = capturedPhotosData.map((photo, index) => `
                <div style="position: relative; border: 2px solid #ddd; border-radius: 8px; overflow: hidden;">
                    <img src="${photo.dataURL}" style="width: 100%; height: auto; display: block;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); color: white; font-size: 0.7rem; padding: 3px; text-align: center;">
                        ${photo.name.split('_')[0]}
                    </div>
                    <button onclick="deletePhoto(${index})" style="position: absolute; bottom: 0; right: 0; background: #f44336; color: white; border: none; padding: 5px; cursor: pointer; border-radius: 5px 0 0 0;">
                        🗑️
                    </button>
                </div>
            `).join('');
            
            document.getElementById('capturedPhotos').style.display = capturedPhotosData.length > 0 ? 'block' : 'none';
            document.getElementById('downloadAllBtn').style.display = capturedPhotosData.length > 0 ? 'inline-flex' : 'none';
        }

        function deletePhoto(index) {
            if (confirm('هل أنت متأكد من حذف هذه الصورة؟')) {
                capturedPhotosData.splice(index, 1);
                displayCapturedPhotos();
            }
        }

        function downloadAllPhotos() {
            if (capturedPhotosData.length === 0) {
                alert('لا توجد صور لتحميلها.');
                return;
            }

            alert('سيتم بدء تحميل الصور الآن. قد تحتاج لتأكيد تحميل كل ملف على حدة.');

            capturedPhotosData.forEach((photo, index) => {
                setTimeout(() => {
                    const a = document.createElement('a');
                    a.href = photo.dataURL;
                    a.download = photo.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }, index * 500); 
            });
        }
        
        function showTab(tabName, btn) { document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(tabName).classList.add('active'); btn.classList.add('active'); }
        function showSection(sectionName) { document.querySelectorAll('.section').forEach(section => section.classList.remove('active')); document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active')); document.querySelector(`[onclick="showSection('${sectionName}')"]`).classList.add('active'); document.getElementById(sectionName).classList.add('active'); }

        // ===================================================
        // 8. وظائف الجدولة والتهيئة (المدمجة)
        // ===================================================

        // ⭐️ دالة مسح الحضور اليومي فقط (للتشغيل التلقائي عند منتصف الليل)
        function resetDailyAttendance() {
             if (!confirm('⚠️ تنبيه: هل تريد إعادة تعيين حالات حضور المعلمات لهذا اليوم يدوياً؟')) return;
            
             teachers.forEach(t => {
                 t.status = 'not-recorded';
                 t.timestamp = '';
             });

             renderTeachers(); 
             updateDailyStars(); 
             updateStats();
             
             syncToSheet('resetAllAttendanceStatus', { id: 0 }); 

             alert('✅ تم مسح سجل الحضور اليومي بنجاح (سيتم إعادة تحميله من الشيت إذا تم تحديثه هناك).');
             loadDataFromSheet();
        }

        // ⭐️ ضبط التشغيل التلقائي عند منتصف الليل
        function scheduleDailyReset() {
            const now = new Date();
            const nextMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0);
            const msUntilMidnight = nextMidnight - now;

            console.log(`⏰ سيتم جدولة إعادة تعيين الحضور عند منتصف الليل (${nextMidnight}).`);

            setTimeout(() => {
                 alert('🔔 تنبيه: يجب أرشفة سجل الحضور الآن لبدء يوم جديد (زر "أرشفة ومسح سجل الحضور" في الإدارة).');
                 
                 scheduleDailyReset(); // إعادة جدولة اليوم التالي
            }, msUntilMidnight);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const apiLinkDisplay = document.getElementById('apiLinkDisplay');
            if (apiLinkDisplay) {
                apiLinkDisplay.textContent = SHEET_API_URL;
            }
            
            const dataLoaded = await loadDataFromSheet();
            
            if (dataLoaded) {
                updateDateTime();
                setInterval(updateDateTime, 60000); 
                
                if (document.getElementById('dataManagementInfo')) {
                    updateDataManagement();
                }
            }
            
            const motivationalTextElement = document.getElementById('motivationalText');
            if(motivationalTextElement) {
                motivationalTextElement.value = motivationalQuote;
            }
            
            // ⭐️ بدء الجدولة التلقائية للحضور
            scheduleDailyReset();

            console.log('✅ تم تحميل النظام مع محاولة مزامنة البيانات.');
        });

        // ===================================================
        // 9. وظائف الشهادات والحفظ (المدمجة والمنقحة)
        // ===================================================

        // ⭐️ دالة لحفظ الشهادة كـ PDF 
        async function saveCertificatePDF(containerId, fileName) {
            const container = document.getElementById(containerId);
            if (!container) {
                alert('❌ لم يتم العثور على عنصر الشهادة.');
                return;
            }

            // التأكد من تحميل أي صور
            const images = container.querySelectorAll('img');
            await Promise.all(Array.from(images).map(img => {
                if (img.complete) return Promise.resolve();
                return new Promise(resolve => { img.onload = img.onerror = resolve; });
            }));

            try {
                // إنشاء canvas
                const canvas = await html2canvas(container, {
                    scale: 2,
                    useCORS: true, 
                    scrollY: -window.scrollY,
                    logging: true
                });
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(fileName);
                alert('✅ تم حفظ الشهادة بنجاح');
            } catch (err) {
                console.error(err);
                alert('❌ حدث خطأ أثناء حفظ الشهادة');
            }
        }


        // ⭐️ دالة مُعدّلة لإنشاء الشهادة في الذاكرة مع المعاينة والحفظ الفوري
        async function generateCertificatePreview({ name, icon, isClass = false, starType = 'شكر وتقدير' }) {
            // 1. إزالة أي شهادة موجودة سابقة في الـ body
            const existing = document.getElementById('certificatePreview');
            if (existing) existing.remove();

            const date = new Date().toLocaleDateString('ar-SA', { year: 'numeric', month: 'long', day: 'numeric' });
            
            // 2. إنشاء العنصر المؤقت (للعرض والحفظ)
            const certificateContainer = document.createElement('div');
            certificateContainer.id = 'certificatePreview';
            certificateContainer.style.width = '800px';
            certificateContainer.style.padding = '3rem';
            certificateContainer.style.background = 'white';
            certificateContainer.style.textAlign = 'center';
            certificateContainer.style.border = '5px solid #ff6b9d'; // نمط جمالي
            certificateContainer.style.position = 'absolute'; // وضعه خارج الشاشة للحفظ
            certificateContainer.style.top = '-9999px';
            certificateContainer.style.margin = '0';
            certificateContainer.style.fontFamily = 'Tajawal, sans-serif';
            certificateContainer.style.direction = 'rtl';
            certificateContainer.style.color = '#333';
            
            const headerLogoHtml = document.querySelector('#siteHeaderLogo')?.outerHTML || '';
            
            let certificateText = isClass ? `تقديراً لانضباطه وأدائه المتميز كنجم الطابور المدرسي` : `تقديراً لجهودها وأدائها المتميز كـ ${starType}`;
            
            // بناء محتوى الشهادة (مع زر حفظ مؤقت داخل العنصر للحفظ)
            const certificateContentHTML = `
                <div class="certificate-header">${headerLogoHtml}</div>
                <h2 style="margin: 1rem 0; color: #ab47bc;">شهادة ${starType}</h2>
                <h3>تمنح ${isClass ? 'لصف' : 'للمعلمة'}: <strong style="color: #ff6b9d;">${name}</strong></h3>
                <p style="font-size: 1.2rem;">${certificateText}</p>
                <div style="font-size: 3rem; margin: 1rem 0;">${icon || '🌟'}</div>
                <p style="margin-top: 2rem;">المدرسة: أم مالك الأنصارية للبنات</p>
                <p style="margin-top: 3rem; font-weight: bold;">مديرة المدرسة</p>
                <p style="font-size: 0.9rem; color: #666;">حررت في: ${date}</p>
            `;

            certificateContainer.innerHTML = certificateContentHTML;
            document.body.appendChild(certificateContainer); 

            // 3. معاينة الشهادة في الواجهة
            const previewContainer = document.getElementById('certificatePreviewContainer');
            if (previewContainer) {
                // عرض المحتوى في منطقة المعاينة (بدون زر الحفظ داخل المعاينة الفعلية)
                previewContainer.innerHTML = certificateContentHTML; 
                
                // إضافة زر الحفظ وربطه بالدالة الجديدة
                 previewContainer.innerHTML += `<div style="margin-top:1rem;"><button id="exportCertificateBtn" class="nav-button" style="background: #28a745;">📥 حفظ PDF الآن</button></div>`;
                
                document.getElementById('certificatePlaceholder').style.display = 'none';

                 // ربط زر الحفظ بالدالة الجديدة
                document.getElementById('exportCertificateBtn').onclick = () => {
                    const fileName = `${name}_${starType.replace(/\s/g, '_')}_${date}.pdf`;
                    // حفظ الشهادة باستخدام العنصر المخفي في الـ body
                    saveCertificatePDF('certificatePreview', fileName); 
                };
            }
            
            // 4. لا نحتاج لإزالة العنصر المؤقت هنا، سيتم استخدامه في دالة الحفظ
            
            return certificateContainer;
        }

        // ⭐️ دالة موحدة لإنشاء الشهادة بناءً على النوع
        function createStarCertificate(type) {
             let name, icon, isClass, starType;

             if (type === 'dailyClass') {
                 const topDailyClass = classes.reduce((max, c) => (c.dailyPoints > (max.dailyPoints || 0) ? c : max), {});
                 if (!topDailyClass.name || topDailyClass.dailyPoints <= 0) return alert('لا يوجد صف مؤهل لنجم الطابور اليوم.');
                 name = topDailyClass.name;
                 icon = '⭐';
                 isClass = true;
                 starType = 'نجم الطابور اليومي';
             } else if (type === 'starOfDay') {
                 const firstPresentTeacher = teachers
                     .filter(t => t.status === 'present' && t.timestamp)
                     .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))[0];
                 if (!firstPresentTeacher) return alert('لا يوجد معلمة مؤهلة لنجم اليوم (يجب أن تسجل حضورها أولاً).');
                 name = firstPresentTeacher.name;
                 icon = '🌟';
                 isClass = false;
                 starType = 'نجمة اليوم';
             } else if (type === 'starOfMonth') {
                 const selectedStar = document.getElementById('starOfMonthSelect').value;
                 if (selectedStar === '' || selectedStar === 'لم يتم الاختيار بعد') return alert('يرجى اختيار نجمة الشهر من قائمة "إدارة النجوم" أولاً.');
                 name = selectedStar.substring(0, selectedStar.indexOf('(')).trim();
                 icon = '🏆';
                 isClass = false;
                 starType = 'نجمة الشهر';
             } else if (type === 'queueStarMonth') {
                 const selectedStar = document.getElementById('queueStarMonthSelect').value;
                 if (selectedStar === '' || selectedStar === 'لم يتم الاختيار بعد') return alert('يرجى اختيار نجم الطابور للشهر من قائمة "إدارة النجوم" أولاً.');
                 name = selectedStar;
                 icon = '👑';
                 isClass = true;
                 starType = 'نجم الطابور للشهر';
             } else if (type === 'attendance') {
                 name = 'جميع المعلمات المتميزات';
                 icon = '📋';
                 isClass = false;
                 starType = 'تقدير للحضور المميز';
             } else {
                 return alert('نوع الشهادة غير صحيح.');
             }
             
             generateCertificatePreview({ name, icon, isClass, starType });
        }
        
        // دالة الطباعة بالمتصفح (للتراجع في حال لم يُرضي التصدير المباشر)
        function printCertificate() {
             alert('يرجى اختيار نوع الشهادة أولاً. سيتم تصديرها كـ PDF مباشرة بمجرد الاختيار.');
        }

        // ===================================================
        // 6. وظائف التقارير (لم تتغير)
        // ===================================================
        
        // ⭐️ دالة موحدة لتوليد وعرض وتصدير تقارير النجوم (محدثة للتصدير المباشر)
        function generateAndExportStarsReport(format, type = 'daily') {
            const reportData = classes.map(c => ({
                'الصف': c.name,
                'نقاط الهدوء': c.quiet,
                'نقاط السرعة': c.speed,
                'نقاط الصوت': c.volume,
                'نقاط النظافة': c.cleanliness,
                'إجمالي اليوم': c.dailyPoints,
                'إجمالي الشهر': c.monthlyPoints,
                'ملاحظات': c.notes
            }));
            
            const reportTitle = `تقرير نجوم الطابور (${type === 'daily' ? 'يومي' : type === 'weekly' ? 'أسبوعي' : 'شهري'})`;
            const fileName = `QueueStars_${type}_Report_${new Date().toLocaleDateString('en-US').replace(/\//g, '-')}`;
            
            displayReport(reportData, reportTitle, 'stars');
            
            if (format !== 'display') exportReportByFormat(format, reportData, reportTitle, fileName);
        }
        
        // ⭐️ دالة موحدة لتوليد وعرض وتصدير تقارير الحضور (محدثة للتصدير المباشر)
        function generateAndExportAttendanceReport(format, type = 'daily') {
            const reportData = teachers.map(t => ({
                'ID': t.id,
                'الاسم': t.name,
                'الصف': t.class,
                'حالة الحضور': getStatusText(t.status),
                'وقت التسجيل': t.timestamp || 'لا يوجد',
                'ملاحظات': t.notes
            }));
            
            const reportTitle = `تقرير حضور المعلمات (${type === 'daily' ? 'يومي' : type === 'weekly' ? 'أسبوعي' : 'شهري'})`;
            const fileName = `Attendance_${type}_Report_${new Date().toLocaleDateString('en-US').replace(/\//g, '-')}`;

            displayReport(reportData, reportTitle, 'attendance');
            
            if (format !== 'display') exportReportByFormat(format, reportData, reportTitle, fileName);
        }

        async function exportReportByFormat(format, data, title, fileName) {
            const reportEl = document.getElementById('reportToExport');
            displayReport(data, title, 'export'); 
            
            if (format === 'excel') {
                 exportToExcel(data, fileName);
            } else if (format === 'pdf') {
                 await exportToPDF('reportToExport', fileName);
            } else if (format === 'image') {
                 await exportToImage('reportToExport', fileName);
            }
        }
        
        function generateAndExportDailyAttendance(format) { generateAndExportAttendanceReport(format, 'daily'); }
        function generateAndExportWeeklyAttendance(format) { generateAndExportAttendanceReport(format, 'weekly'); alert('عرض التقرير الأسبوعي يستخدم حالياً بيانات اليوم.'); }
        function generateAndExportMonthlyAttendance(format) { generateAndExportAttendanceReport(format, 'monthly'); alert('عرض التقرير الشهري يستخدم حالياً بيانات اليوم.'); }

        function generateAndExportDailyStars(format) { generateAndExportStarsReport(format, 'daily'); }
        function generateAndExportWeeklyStars(format) { generateAndExportStarsReport(format, 'weekly'); alert('عرض التقرير الأسبوعي يستخدم حالياً بيانات اليوم.'); }
        function generateAndExportMonthlyStars(format) { generateAndExportStarsReport(format, 'monthly'); alert('عرض التقرير الشهري يستخدم حالياً بيانات اليوم.'); }
        
        function exportCompleteReport(format) {
             const allData = {
                'Attendance': teachers.map(t => ({
                    'ID': t.id,
                    'الاسم': t.name,
                    'الصف': t.class,
                    'حالة الحضور': getStatusText(t.status),
                    'وقت التسجيل': t.timestamp || 'لا يوجد',
                    'ملاحظات': t.notes
                })),
                'QueueStars': classes.map(c => ({
                    'الصف': c.name,
                    'نقاط اليوم': c.dailyPoints,
                    'نقاط الشهر': c.monthlyPoints,
                    'نقاط الهدوء': c.quiet,
                    'نقاط السرعة': c.speed,
                    'نقاط الصوت': c.volume,
                    'نقاط النظافة': c.cleanliness,
                    'ملاحظات': c.notes
                }))
            };
            const reportTitle = `التقرير الشامل - ${new Date().toLocaleDateString('ar-SA')}`;
            const fileName = `Comprehensive_Report_${new Date().toLocaleDateString('en-US').replace(/\//g, '-')}`;
            
            if (format === 'excel') {
                exportMultipleSheetsToExcel(allData, fileName);
            } else {
                alert('لا يمكن عرض التقرير الشامل (PDF/Image) على شكل معاينة. سيتم تصدير نسخة Excel فقط.');
            }
        }

        function displayReport(data, title, type) {
            const previewContainer = document.getElementById('reportPreviewContainer');
            const preview = document.getElementById('reportToExport');
            document.getElementById('reportPlaceholder').style.display = 'none';

            let tableHtml = `<div class="report-preview-container" style="padding: 2rem; border-radius: 15px; background: #fff; color: #333; text-align: right;">
                <div class="report-header">
                    <h2 class="report-title">${title}</h2>
                    <p class="report-date">تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>
                </div>
                <table border="1" id="reportTable" style="width:100%; border-collapse:collapse; text-align:center; font-size: 0.9rem;">
                    <thead><tr>`;
            
            const headers = Object.keys(data[0] || {});
            headers.forEach(header => {
                tableHtml += `<th style="padding: 0.5rem; background: #ab47bc; color: white;">${header}</th>`;
            });
            tableHtml += `</tr></thead><tbody>`;

            data.forEach(row => {
                tableHtml += `<tr>`;
                headers.forEach(header => {
                    tableHtml += `<td style="padding: 0.5rem;">${row[header]}</td>`;
                });
                tableHtml += `</tr>`;
            });

            tableHtml += `</tbody></table></div>`;
            
            preview.innerHTML = tableHtml;
            preview.style.display = 'block';
            previewContainer.scrollTop = 0; 
        }

        function exportToExcel(data, fileName) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'البيانات');
            XLSX.writeFile(wb, `${fileName}.xlsx`);
            alert(`✅ تم تصدير ${fileName}.xlsx بنجاح.`);
        }
        
        function exportMultipleSheetsToExcel(data, fileName) {
             const wb = XLSX.utils.book_new();
             for (const sheetName in data) {
                 const ws = XLSX.utils.json_to_sheet(data[sheetName]);
                 XLSX.utils.book_append_sheet(wb, ws, sheetName);
             }
             XLSX.writeFile(wb, `${fileName}.xlsx`);
             alert(`✅ تم تصدير ${fileName}.xlsx بصفحات متعددة بنجاح.`);
        }

        async function exportToPDF(elementId, fileName) {
            const element = document.getElementById(elementId);
             if (!element || element.style.display === 'none') {
                 alert('❌ يرجى عرض التقرير أولاً في المعاينة قبل التصدير.');
                 return;
             }
            await new Promise(resolve => setTimeout(resolve, 200)); 

            html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 200; 
                const pageHeight = 290;
                const imgHeight = canvas.height * imgWidth / canvas.width;

                pdf.addImage(imgData, 'PNG', 5, 5, imgWidth, imgHeight);
                pdf.save(`${fileName}.pdf`);
                alert(`✅ تم تصدير ${fileName}.pdf بنجاح.`);
            }).catch(error => {
                console.error("Error generating PDF:", error);
                alert("❌ فشل في إنشاء ملف PDF. يرجى مراجعة الكونسول.");
            });
        }
        
        async function exportToImage(elementId, fileName) {
            const element = document.getElementById(elementId);
            if (!element || element.style.display === 'none') {
                 alert('❌ يرجى عرض التقرير أولاً في المعاينة قبل التصدير.');
                 return;
            }
             await new Promise(resolve => setTimeout(resolve, 200)); 

            html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                canvas.toBlob(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${fileName}.png`;
                    link.click();
                    alert(`✅ تم تصدير ${fileName}.png بنجاح.`);
                }, 'image/png');
            });
        }

        function printReport() {
            const preview = document.getElementById('reportToExport');
             if (preview.style.display === 'none') {
                alert('يرجى اختيار نوع التقرير لمعاينته أولاً.');
                return;
            }
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>طباعة التقرير</title><style>.report-preview-container{ padding: 2rem; border-radius: 15px; background: #fff; color: #333; text-align: right; } table, th, td { border: 1px solid #ddd; border-collapse: collapse; padding: 8px; text-align: right; } th { background: #ab47bc; color: white; }</style></head><body style="direction:rtl; font-family: \'Tajawal\', sans-serif;">');
            printWindow.document.write(preview.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        // ===================================================
        // 7. وظائف النسخ الاحتياطي والكاميرا (لم تتغير)
        // ===================================================
        function exportSavedData() {
            const dataToExport = {
                teachers: teachers,
                classes: classes,
                systemPassword: systemPassword,
                motivationalQuote: motivationalQuote
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `QueueSystem_Backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('✅ تم تصدير النسخة الاحتياطية بنجاح.');
        }

        function importSavedData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!confirm('⚠️ هل أنت متأكد من استيراد البيانات؟ هذا سيحل محل البيانات الحالية. لن يؤثر على بيانات Google Sheet حتى تقوم بالمزامنة يدوياً.')) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        teachers = importedData.teachers || [];
                        classes = importedData.classes || [];
                        systemPassword = importedData.systemPassword || 'admin123';
                        motivationalQuote = importedData.motivationalQuote || 'انضباط يعكس وعيًا ونظام يصنع الأجيال';

                        renderTeachers();
                        renderClasses();
                        updateStats();
                        updateStarSummaries();
                        renderTeachersManagementList();
                        updateDataManagement();
                        document.getElementById('motivationalSubtitle').textContent = motivationalQuote;
                        document.getElementById('motivationalText').value = motivationalQuote;
                        
                        alert('✅ تم استيراد البيانات المحلية بنجاح! يرجى تحديث البيانات من الشيت إذا كنت تريد استعادة البيانات السحابية.');
                    } catch (error) {
                        alert(`❌ فشل في تحليل ملف JSON: ${error.message}`);
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllSavedData() {
            if (confirm('⚠️ هل أنت متأكد من مسح جميع البيانات المحلية (المعلمات، الصفوف، النقاط، الإعدادات)؟ هذا لن يؤثر على بيانات Google Sheet، ويمكنك استعادتها منه لاحقاً.')) {
                teachers = [];
                classes = [];
                systemPassword = 'admin123';
                motivationalQuote = 'انضباط يعكس وعيًا ونظام يصنع الأجيال';
                
                renderTeachers();
                renderClasses();
                updateStats();
                updateStarSummaries();
                renderTeachersManagementList();
                updateDataManagement();
                document.getElementById('motivationalSubtitle').textContent = motivationalQuote;
                document.getElementById('motivationalText').value = motivationalQuote;
                
                alert('✅ تم مسح جميع البيانات المحلية. يرجى تحديث البيانات من الشيت لاستعادة البيانات السحابية.');
            }
        }
        
        function openCameraModal(teacherId, teacherName, className) {
            currentCameraTeacherId = teacherId;
            document.getElementById('overlayTeacherName').textContent = teacherName;
            document.getElementById('overlayClassName').textContent = className;
            document.getElementById('cameraModal').classList.add('active');
            updateCameraDateTime();
            
            startCamera();
        }

        function closeCameraModal() {
            stopCamera();
            document.getElementById('cameraModal').classList.remove('active');
            currentCameraTeacherId = null;
        }

        function updateCameraDateTime() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('overlayDateTime').textContent = now.toLocaleDateString('ar-SA', options);
        }

        async function getAvailableCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(device => device.kind === 'videoinput');
                console.log('Available cameras:', availableCameras);
            } catch (error) {
                console.error('Error enumerating devices:', error);
                availableCameras = [];
            }
        }

        async function startCamera(deviceId = null) {
            const video = document.getElementById('cameraVideo');
            const statusDiv = document.getElementById('cameraStatus');
            
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'جاري التشغيل...';
            
            if (!availableCameras.length) await getAvailableCameras();

            if (!availableCameras.length) {
                statusDiv.innerHTML = '<span style="color: red;">❌ لم يتم العثور على كاميرات. تأكد من السماح بالوصول.</span>';
                return;
            }

            const constraint = deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' }; 

            try {
                if (cameraStream) stopCamera();
                
                const constraints = {
                    video: constraint
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = cameraStream;
                video.onloadedmetadata = () => {
                    video.play();
                    statusDiv.innerHTML = '<span style="color: green;">✅ الكاميرا قيد التشغيل.</span>';
                    document.getElementById('startCameraBtn').style.display = 'none';
                    document.getElementById('captureBtn').style.display = 'inline-flex';
                    document.getElementById('switchCameraBtn').style.display = availableCameras.length > 1 ? 'inline-flex' : 'none';
                    document.getElementById('stopCameraBtn').style.display = 'inline-flex';
                    
                    const currentTrack = cameraStream.getVideoTracks()[0];
                    const currentCamIndex = availableCameras.findIndex(d => d.deviceId === currentTrack.getSettings().deviceId);
                    currentCameraIndex = currentCamIndex !== -1 ? currentCamIndex : 0;
                };

                setInterval(updateCameraDateTime, 1000); 
            } catch (error) {
                console.error('Error starting camera:', error);
                statusDiv.innerHTML = '<span style="color: red;">❌ خطأ في الوصول للكاميرا. تأكد من السماح بالوصول.</span>';
                document.getElementById('startCameraBtn').style.display = 'inline-flex';
                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('switchCameraBtn').style.display = 'none';
                document.getElementById('stopCameraBtn').style.display = 'none';
            }
        }
        
        function switchCamera() {
            if (availableCameras.length <= 1) {
                alert('لا توجد كاميرات أخرى للتبديل إليها.');
                return;
            }
            
            stopCamera(); 
            
            currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
            const nextCameraId = availableCameras[currentCameraIndex].deviceId;
            
            startCamera(nextCameraId); 
        }

        function stopCamera() {
            const video = document.getElementById('cameraVideo');
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                cameraStream = null;
                document.getElementById('cameraStatus').innerHTML = 'الكاميرا متوقفة.';
                document.getElementById('startCameraBtn').style.display = 'inline-flex';
                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('switchCameraBtn').style.display = 'none';
                document.getElementById('stopCameraBtn').style.display = 'none';
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const overlay = document.getElementById('photoOverlay');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // إضافة الـ Overlay كنص على الصورة
            ctx.font = "24px 'Tajawal', sans-serif";
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)'; 
            ctx.fillRect(10, canvas.height - 100, canvas.width - 20, 80); 
            
            ctx.fillStyle = 'white';
            ctx.textAlign = 'right';
            const teacherName = document.getElementById('overlayTeacherName').textContent;
            const className = document.getElementById('overlayClassName').textContent;
            const dateTime = document.getElementById('overlayDateTime').textContent;
            
            ctx.fillText(teacherName, canvas.width - 20, canvas.height - 75);
            ctx.font = "20px 'Tajawal', sans-serif";
            ctx.fillText(className, canvas.width - 20, canvas.height - 50);
            ctx.font = "16px 'Tajawal', sans-serif";
            ctx.fillText(dateTime, canvas.width - 20, canvas.height - 25);


            const imageDataURL = canvas.toDataURL('image/png');
            
            // حفظ الصورة
            const photoName = `${document.getElementById('overlayTeacherName').textContent}_${new Date().getTime()}.png`;
            capturedPhotosData.push({ dataURL: imageDataURL, name: photoName });
            
            displayCapturedPhotos();
            document.getElementById('cameraStatus').innerHTML = `<span style="color: #ff6b9d;">📸 تم التقاط وحفظ صورة ${photoName}.</span>`;
        }

        function displayCapturedPhotos() {
            const grid = document.getElementById('photosGrid');
            grid.innerHTML = capturedPhotosData.map((photo, index) => `
                <div style="position: relative; border: 2px solid #ddd; border-radius: 8px; overflow: hidden;">
                    <img src="${photo.dataURL}" style="width: 100%; height: auto; display: block;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); color: white; font-size: 0.7rem; padding: 3px; text-align: center;">
                        ${photo.name.split('_')[0]}
                    </div>
                    <button onclick="deletePhoto(${index})" style="position: absolute; bottom: 0; right: 0; background: #f44336; color: white; border: none; padding: 5px; cursor: pointer; border-radius: 5px 0 0 0;">
                        🗑️
                    </button>
                </div>
            `).join('');
            
            document.getElementById('capturedPhotos').style.display = capturedPhotosData.length > 0 ? 'block' : 'none';
            document.getElementById('downloadAllBtn').style.display = capturedPhotosData.length > 0 ? 'inline-flex' : 'none';
        }

        function deletePhoto(index) {
            if (confirm('هل أنت متأكد من حذف هذه الصورة؟')) {
                capturedPhotosData.splice(index, 1);
                displayCapturedPhotos();
            }
        }

        function downloadAllPhotos() {
            if (capturedPhotosData.length === 0) {
                alert('لا توجد صور لتحميلها.');
                return;
            }

            alert('سيتم بدء تحميل الصور الآن. قد تحتاج لتأكيد تحميل كل ملف على حدة.');

            capturedPhotosData.forEach((photo, index) => {
                setTimeout(() => {
                    const a = document.createElement('a');
                    a.href = photo.dataURL;
                    a.download = photo.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }, index * 500); 
            });
        }
        
        function showTab(tabName, btn) { document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(tabName).classList.add('active'); btn.classList.add('active'); }
        function showSection(sectionName) { document.querySelectorAll('.section').forEach(section => section.classList.remove('active')); document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active')); document.querySelector(`[onclick="showSection('${sectionName}')"]`).classList.add('active'); document.getElementById(sectionName).classList.add('active'); }

        // ===================================================
        // 8. وظائف الجدولة والتهيئة (المدمجة)
        // ===================================================

        // ⭐️ دالة مسح الحضور اليومي فقط (للتشغيل التلقائي عند منتصف الليل)
        function resetDailyAttendance() {
             if (!confirm('⚠️ تنبيه: هل تريد إعادة تعيين حالات حضور المعلمات لهذا اليوم يدوياً؟')) return;
            
             teachers.forEach(t => {
                 t.status = 'not-recorded';
                 t.timestamp = '';
             });

             renderTeachers(); 
             updateDailyStars(); 
             updateStats();
             
             syncToSheet('resetAllAttendanceStatus', { id: 0 }); 

             alert('✅ تم مسح سجل الحضور اليومي بنجاح (سيتم إعادة تحميله من الشيت إذا تم تحديثه هناك).');
             loadDataFromSheet();
        }

        // ⭐️ ضبط التشغيل التلقائي عند منتصف الليل
        function scheduleDailyReset() {
            const now = new Date();
            const nextMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0);
            const msUntilMidnight = nextMidnight - now;

            console.log(`⏰ سيتم جدولة إعادة تعيين الحضور عند منتصف الليل (${nextMidnight}).`);

            setTimeout(() => {
                 alert('🔔 تنبيه: يجب أرشفة سجل الحضور الآن لبدء يوم جديد (زر "أرشفة ومسح سجل الحضور" في الإدارة).');
                 
                 scheduleDailyReset(); // إعادة جدولة اليوم التالي
            }, msUntilMidnight);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const apiLinkDisplay = document.getElementById('apiLinkDisplay');
            if (apiLinkDisplay) {
                apiLinkDisplay.textContent = SHEET_API_URL;
            }
            
            const dataLoaded = await loadDataFromSheet();
            
            if (dataLoaded) {
                updateDateTime();
                setInterval(updateDateTime, 60000); 
                
                if (document.getElementById('dataManagementInfo')) {
                    updateDataManagement();
                }
            }
            
            const motivationalTextElement = document.getElementById('motivationalText');
            if(motivationalTextElement) {
                motivationalTextElement.value = motivationalQuote;
            }
            
            // ⭐️ بدء الجدولة التلقائية للحضور
            scheduleDailyReset();

            console.log('✅ تم تحميل النظام مع محاولة مزامنة البيانات.');
        });

        // ===================================================
        // 9. وظائف الشهادات والحفظ (المدمجة والمنقحة)
        // ===================================================

        // ⭐️ دالة لحفظ الشهادة كـ PDF 
        async function saveCertificatePDF(containerId, fileName) {
            const container = document.getElementById(containerId);
            if (!container) {
                alert('❌ لم يتم العثور على عنصر الشهادة.');
                return;
            }

            // التأكد من تحميل أي صور
            const images = container.querySelectorAll('img');
            await Promise.all(Array.from(images).map(img => {
                if (img.complete) return Promise.resolve();
                return new Promise(resolve => { img.onload = img.onerror = resolve; });
            }));

            try {
                // إنشاء canvas
                const canvas = await html2canvas(container, {
                    scale: 2,
                    useCORS: true, 
                    scrollY: -window.scrollY,
                    logging: true
                });
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(fileName);
                alert('✅ تم حفظ الشهادة بنجاح');
            } catch (err) {
                console.error(err);
                alert('❌ حدث خطأ أثناء حفظ الشهادة');
            }
        }


        // ⭐️ دالة مُعدّلة لإنشاء الشهادة في الذاكرة مع المعاينة والحفظ الفوري
        async function generateCertificatePreview({ name, icon, isClass = false, starType = 'شكر وتقدير' }) {
            // 1. إزالة أي شهادة موجودة سابقة في الـ body
            const existing = document.getElementById('certificatePreview');
            if (existing) existing.remove();

            const date = new Date().toLocaleDateString('ar-SA', { year: 'numeric', month: 'long', day: 'numeric' });
            
            // 2. إنشاء العنصر المؤقت (للعرض والحفظ)
            const certificateContainer = document.createElement('div');
            certificateContainer.id = 'certificatePreview';
            certificateContainer.style.width = '800px';
            certificateContainer.style.padding = '3rem';
            certificateContainer.style.background = 'white';
            certificateContainer.style.textAlign = 'center';
            certificateContainer.style.border = '5px solid #ff6b9d'; // نمط جمالي
            certificateContainer.style.position = 'absolute'; // وضعه خارج الشاشة للحفظ
            certificateContainer.style.top = '-9999px';
            certificateContainer.style.margin = '0';
            certificateContainer.style.fontFamily = 'Tajawal, sans-serif';
            certificateContainer.style.direction = 'rtl';
            certificateContainer.style.color = '#333';
            
            const headerLogoHtml = document.querySelector('#siteHeaderLogo')?.outerHTML || '';
            
            let certificateText = isClass ? `تقديراً لانضباطه وأدائه المتميز كنجم الطابور المدرسي` : `تقديراً لجهودها وأدائها المتميز كـ ${starType}`;
            
            // بناء محتوى الشهادة
            const certificateContentHTML = `
                <div class="certificate-header">${headerLogoHtml}</div>
                <h2 style="margin: 1rem 0; color: #ab47bc;">شهادة ${starType}</h2>
                <h3>تمنح ${isClass ? 'لصف' : 'للمعلمة'}: <strong style="color: #ff6b9d;">${name}</strong></h3>
                <p style="font-size: 1.2rem;">${certificateText}</p>
                <div style="font-size: 3rem; margin: 1rem 0;">${icon || '🌟'}</div>
                <p style="margin-top: 2rem;">المدرسة: أم مالك الأنصارية للبنات</p>
                <p style="margin-top: 3rem; font-weight: bold;">مديرة المدرسة</p>
                <p style="font-size: 0.9rem; color: #666;">حررت في: ${date}</p>
            `;

            certificateContainer.innerHTML = certificateContentHTML;
            document.body.appendChild(certificateContainer); 

            // 3. معاينة الشهادة في الواجهة
            const previewContainer = document.getElementById('certificatePreviewContainer');
            if (previewContainer) {
                // عرض المحتوى في منطقة المعاينة (بدون زر الحفظ داخل المعاينة الفعلية)
                previewContainer.innerHTML = certificateContentHTML; 
                
                // إضافة زر الحفظ وربطه بالدالة الجديدة
                 previewContainer.innerHTML += `<div style="margin-top:1rem;"><button id="exportCertificateBtn" class="nav-button" style="background: #28a745;">📥 حفظ PDF الآن</button></div>`;
                
                document.getElementById('certificatePlaceholder').style.display = 'none';

                 // ربط زر الحفظ بالدالة الجديدة
                document.getElementById('exportCertificateBtn').onclick = () => {
                    const fileName = `${name}_${starType.replace(/\s/g, '_')}_${date}.pdf`;
                    // حفظ الشهادة باستخدام العنصر المخفي في الـ body
                    saveCertificatePDF('certificatePreview', fileName); 
                };
            }
            
            return certificateContainer;
        }

        // ⭐️ دالة موحدة لإنشاء الشهادة بناءً على النوع
        function createStarCertificate(type) {
             let name, icon, isClass, starType;

             if (type === 'dailyClass') {
                 const topDailyClass = classes.reduce((max, c) => (c.dailyPoints > (max.dailyPoints || 0) ? c : max), {});
                 if (!topDailyClass.name || topDailyClass.dailyPoints <= 0) return alert('لا يوجد صف مؤهل لنجم الطابور اليوم.');
                 name = topDailyClass.name;
                 icon = '⭐';
                 isClass = true;
                 starType = 'نجم الطابور اليومي';
             } else if (type === 'starOfDay') {
                 const firstPresentTeacher = teachers
                     .filter(t => t.status === 'present' && t.timestamp)
                     .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))[0];
                 if (!firstPresentTeacher) return alert('لا يوجد معلمة مؤهلة لنجم اليوم (يجب أن تسجل حضورها أولاً).');
                 name = firstPresentTeacher.name;
                 icon = '🌟';
                 isClass = false;
                 starType = 'نجمة اليوم';
             } else if (type === 'starOfMonth') {
                 const selectedStar = document.getElementById('starOfMonthSelect').value;
                 if (selectedStar === '' || selectedStar === 'لم يتم الاختيار بعد') return alert('يرجى اختيار نجمة الشهر من قائمة "إدارة النجوم" أولاً.');
                 name = selectedStar.substring(0, selectedStar.indexOf('(')).trim();
                 icon = '🏆';
                 isClass = false;
                 starType = 'نجمة الشهر';
             } else if (type === 'queueStarMonth') {
                 const selectedStar = document.getElementById('queueStarMonthSelect').value;
                 if (selectedStar === '' || selectedStar === 'لم يتم الاختيار بعد') return alert('يرجى اختيار نجم الطابور للشهر من قائمة "إدارة النجوم" أولاً.');
                 name = selectedStar;
                 icon = '👑';
                 isClass = true;
                 starType = 'نجم الطابور للشهر';
             } else if (type === 'attendance') {
                 name = 'جميع المعلمات المتميزات';
                 icon = '📋';
                 isClass = false;
                 starType = 'تقدير للحضور المميز';
             } else {
                 return alert('نوع الشهادة غير صحيح.');
             }
             
             generateCertificatePreview({ name, icon, isClass, starType });
        }
        
        // دالة الطباعة بالمتصفح (للتراجع في حال لم يُرضي التصدير المباشر)
        function printCertificate() {
             alert('يرجى اختيار نوع الشهادة أولاً. سيتم تصديرها كـ PDF مباشرة بمجرد الاختيار.');
        }

        // ===================================================
        // 6. وظائف التقارير (لم تتغير)
        // ===================================================
        
        // ⭐️ دالة موحدة لتوليد وعرض وتصدير تقارير النجوم (محدثة للتصدير المباشر)
        function generateAndExportStarsReport(format, type = 'daily') {
            const reportData = classes.map(c => ({
                'الصف': c.name,
                'نقاط الهدوء': c.quiet,
                'نقاط السرعة': c.speed,
                'نقاط الصوت': c.volume,
                'نقاط النظافة': c.cleanliness,
                'إجمالي اليوم': c.dailyPoints,
                'إجمالي الشهر': c.monthlyPoints,
                'ملاحظات': c.notes
            }));
            
            const reportTitle = `تقرير نجوم الطابور (${type === 'daily' ? 'يومي' : type === 'weekly' ? 'أسبوعي' : 'شهري'})`;
            const fileName = `QueueStars_${type}_Report_${new Date().toLocaleDateString('en-US').replace(/\//g, '-')}`;
            
            displayReport(reportData, reportTitle, 'stars');
            
            if (format !== 'display') exportReportByFormat(format, reportData, reportTitle, fileName);
        }
        
        // ⭐️ دالة موحدة لتوليد وعرض وتصدير تقارير الحضور (محدثة للتصدير المباشر)
        function generateAndExportAttendanceReport(format, type = 'daily') {
            const reportData = teachers.map(t => ({
                'ID': t.id,
                'الاسم': t.name,
                'الصف': t.class,
                'حالة الحضور': getStatusText(t.status),
                'وقت التسجيل': t.timestamp || 'لا يوجد',
                'ملاحظات': t.notes
            }));
            
            const reportTitle = `تقرير حضور المعلمات (${type === 'daily' ? 'يومي' : type === 'weekly' ? 'أسبوعي' : 'شهري'})`;
            const fileName = `Attendance_${type}_Report_${new Date().toLocaleDateString('en-US').replace(/\//g, '-')}`;

            displayReport(reportData, reportTitle, 'attendance');
            
            if (format !== 'display') exportReportByFormat(format, reportData, reportTitle, fileName);
        }

        async function exportReportByFormat(format, data, title, fileName) {
            const reportEl = document.getElementById('reportToExport');
            displayReport(data, title, 'export'); 
            
            if (format === 'excel') {
                 exportToExcel(data, fileName);
            } else if (format === 'pdf') {
                 await exportToPDF('reportToExport', fileName);
            } else if (format === 'image') {
                 await exportToImage('reportToExport', fileName);
            }
        }
        
        function generateAndExportDailyAttendance(format) { generateAndExportAttendanceReport(format, 'daily'); }
        function generateAndExportWeeklyAttendance(format) { generateAndExportAttendanceReport(format, 'weekly'); alert('عرض التقرير الأسبوعي يستخدم حالياً بيانات اليوم.'); }
        function generateAndExportMonthlyAttendance(format) { generateAndExportAttendanceReport(format, 'monthly'); alert('عرض التقرير الشهري يستخدم حالياً بيانات اليوم.'); }

        function generateAndExportDailyStars(format) { generateAndExportStarsReport(format, 'daily'); }
        function generateAndExportWeeklyStars(format) { generateAndExportStarsReport(format, 'weekly'); alert('عرض التقرير الأسبوعي يستخدم حالياً بيانات اليوم.'); }
        function generateAndExportMonthlyStars(format) { generateAndExportStarsReport(format, 'monthly'); alert('عرض التقرير الشهري يستخدم حالياً بيانات اليوم.'); }
        
        function exportCompleteReport(format) {
             const allData = {
                'Attendance': teachers.map(t => ({
                    'ID': t.id,
                    'الاسم': t.name,
                    'الصف': t.class,
                    'حالة الحضور': getStatusText(t.status),
                    'وقت التسجيل': t.timestamp || 'لا يوجد',
                    'ملاحظات': t.notes
                })),
                'QueueStars': classes.map(c => ({
                    'الصف': c.name,
                    'نقاط اليوم': c.dailyPoints,
                    'نقاط الشهر': c.monthlyPoints,
                    'نقاط الهدوء': c.quiet,
                    'نقاط السرعة': c.speed,
                    'نقاط الصوت': c.volume,
                    'نقاط النظافة': c.cleanliness,
                    'ملاحظات': c.notes
                }))
            };
            const reportTitle = `التقرير الشامل - ${new Date().toLocaleDateString('ar-SA')}`;
            const fileName = `Comprehensive_Report_${new Date().toLocaleDateString('en-US').replace(/\//g, '-')}`;
            
            if (format === 'excel') {
                exportMultipleSheetsToExcel(allData, fileName);
            } else {
                alert('لا يمكن عرض التقرير الشامل (PDF/Image) على شكل معاينة. سيتم تصدير نسخة Excel فقط.');
            }
        }

        function displayReport(data, title, type) {
            const previewContainer = document.getElementById('reportPreviewContainer');
            const preview = document.getElementById('reportToExport');
            document.getElementById('reportPlaceholder').style.display = 'none';

            let tableHtml = `<div class="report-preview-container" style="padding: 2rem; border-radius: 15px; background: #fff; color: #333; text-align: right;">
                <div class="report-header">
                    <h2 class="report-title">${title}</h2>
                    <p class="report-date">تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>
                </div>
                <table border="1" id="reportTable" style="width:100%; border-collapse:collapse; text-align:center; font-size: 0.9rem;">
                    <thead><tr>`;
            
            const headers = Object.keys(data[0] || {});
            headers.forEach(header => {
                tableHtml += `<th style="padding: 0.5rem; background: #ab47bc; color: white;">${header}</th>`;
            });
            tableHtml += `</tr></thead><tbody>`;

            data.forEach(row => {
                tableHtml += `<tr>`;
                headers.forEach(header => {
                    tableHtml += `<td style="padding: 0.5rem;">${row[header]}</td>`;
                });
                tableHtml += `</tr>`;
            });

            tableHtml += `</tbody></table></div>`;
            
            preview.innerHTML = tableHtml;
            preview.style.display = 'block';
            previewContainer.scrollTop = 0; 
        }

        function exportToExcel(data, fileName) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'البيانات');
            XLSX.writeFile(wb, `${fileName}.xlsx`);
            alert(`✅ تم تصدير ${fileName}.xlsx بنجاح.`);
        }
        
        function exportMultipleSheetsToExcel(data, fileName) {
             const wb = XLSX.utils.book_new();
             for (const sheetName in data) {
                 const ws = XLSX.utils.json_to_sheet(data[sheetName]);
                 XLSX.utils.book_append_sheet(wb, ws, sheetName);
             }
             XLSX.writeFile(wb, `${fileName}.xlsx`);
             alert(`✅ تم تصدير ${fileName}.xlsx بصفحات متعددة بنجاح.`);
        }

        async function exportToPDF(elementId, fileName) {
            const element = document.getElementById(elementId);
             if (!element || element.style.display === 'none') {
                 alert('❌ يرجى عرض التقرير أولاً في المعاينة قبل التصدير.');
                 return;
             }
            await new Promise(resolve => setTimeout(resolve, 200)); 

            html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 200; 
                const pageHeight = 290;
                const imgHeight = canvas.height * imgWidth / canvas.width;

                pdf.addImage(imgData, 'PNG', 5, 5, imgWidth, imgHeight);
                pdf.save(`${fileName}.pdf`);
                alert(`✅ تم تصدير ${fileName}.pdf بنجاح.`);
            }).catch(error => {
                console.error("Error generating PDF:", error);
                alert("❌ فشل في إنشاء ملف PDF. يرجى مراجعة الكونسول.");
            });
        }
        
        async function exportToImage(elementId, fileName) {
            const element = document.getElementById(elementId);
            if (!element || element.style.display === 'none') {
                 alert('❌ يرجى عرض التقرير أولاً في المعاينة قبل التصدير.');
                 return;
            }
             await new Promise(resolve => setTimeout(resolve, 200)); 

            html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                canvas.toBlob(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${fileName}.png`;
                    link.click();
                    alert(`✅ تم تصدير ${fileName}.png بنجاح.`);
                }, 'image/png');
            });
        }

        function printReport() {
            const preview = document.getElementById('reportToExport');
             if (preview.style.display === 'none') {
                alert('يرجى اختيار نوع التقرير لمعاينته أولاً.');
                return;
            }
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>طباعة التقرير</title><style>.report-preview-container{ padding: 2rem; border-radius: 15px; background: #fff; color: #333; text-align: right; } table, th, td { border: 1px solid #ddd; border-collapse: collapse; padding: 8px; text-align: right; } th { background: #ab47bc; color: white; }</style></head><body style="direction:rtl; font-family: \'Tajawal\', sans-serif;">');
            printWindow.document.write(preview.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        // ===================================================
        // 7. وظائف النسخ الاحتياطي والكاميرا (لم تتغير)
        // ===================================================
        function exportSavedData() {
            const dataToExport = {
                teachers: teachers,
                classes: classes,
                systemPassword: systemPassword,
                motivationalQuote: motivationalQuote
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `QueueSystem_Backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('✅ تم تصدير النسخة الاحتياطية بنجاح.');
        }

        function importSavedData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!confirm('⚠️ هل أنت متأكد من استيراد البيانات؟ هذا سيحل محل البيانات الحالية. لن يؤثر على بيانات Google Sheet حتى تقوم بالمزامنة يدوياً.')) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        teachers = importedData.teachers || [];
                        classes = importedData.classes || [];
                        systemPassword = importedData.systemPassword || 'admin123';
                        motivationalQuote = importedData.motivationalQuote || 'انضباط يعكس وعيًا ونظام يصنع الأجيال';

                        renderTeachers();
                        renderClasses();
                        updateStats();
                        updateStarSummaries();
                        renderTeachersManagementList();
                        updateDataManagement();
                        document.getElementById('motivationalSubtitle').textContent = motivationalQuote;
                        document.getElementById('motivationalText').value = motivationalQuote;
                        
                        alert('✅ تم استيراد البيانات المحلية بنجاح! يرجى تحديث البيانات من الشيت إذا كنت تريد استعادة البيانات السحابية.');
                    } catch (error) {
                        alert(`❌ فشل في تحليل ملف JSON: ${error.message}`);
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllSavedData() {
            if (confirm('⚠️ هل أنت متأكد من مسح جميع البيانات المحلية (المعلمات، الصفوف، النقاط، الإعدادات)؟ هذا لن يؤثر على بيانات Google Sheet، ويمكنك استعادتها منه لاحقاً.')) {
                teachers = [];
                classes = [];
                systemPassword = 'admin123';
                motivationalQuote = 'انضباط يعكس وعيًا ونظام يصنع الأجيال';
                
                renderTeachers();
                renderClasses();
                updateStats();
                updateStarSummaries();
                renderTeachersManagementList();
                updateDataManagement();
                document.getElementById('motivationalSubtitle').textContent = motivationalQuote;
                document.getElementById('motivationalText').value = motivationalQuote;
                
                alert('✅ تم مسح جميع البيانات المحلية. يرجى تحديث البيانات من الشيت لاستعادة البيانات السحابية.');
            }
        }
        
        function openCameraModal(teacherId, teacherName, className) {
            currentCameraTeacherId = teacherId;
            document.getElementById('overlayTeacherName').textContent = teacherName;
            document.getElementById('overlayClassName').textContent = className;
            document.getElementById('cameraModal').classList.add('active');
            updateCameraDateTime();
            
            startCamera();
        }

        function closeCameraModal() {
            stopCamera();
            document.getElementById('cameraModal').classList.remove('active');
            currentCameraTeacherId = null;
        }

        function updateCameraDateTime() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('overlayDateTime').textContent = now.toLocaleDateString('ar-SA', options);
        }

        async function getAvailableCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(device => device.kind === 'videoinput');
                console.log('Available cameras:', availableCameras);
            } catch (error) {
                console.error('Error enumerating devices:', error);
                availableCameras = [];
            }
        }

        async function startCamera(deviceId = null) {
            const video = document.getElementById('cameraVideo');
            const statusDiv = document.getElementById('cameraStatus');
            
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'جاري التشغيل...';
            
            if (!availableCameras.length) await getAvailableCameras();

            if (!availableCameras.length) {
                statusDiv.innerHTML = '<span style="color: red;">❌ لم يتم العثور على كاميرات. تأكد من السماح بالوصول.</span>';
                return;
            }

            const constraint = deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' }; 

            try {
                if (cameraStream) stopCamera();
                
                const constraints = {
                    video: constraint
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = cameraStream;
                video.onloadedmetadata = () => {
                    video.play();
                    statusDiv.innerHTML = '<span style="color: green;">✅ الكاميرا قيد التشغيل.</span>';
                    document.getElementById('startCameraBtn').style.display = 'none';
                    document.getElementById('captureBtn').style.display = 'inline-flex';
                    document.getElementById('switchCameraBtn').style.display = availableCameras.length > 1 ? 'inline-flex' : 'none';
                    document.getElementById('stopCameraBtn').style.display = 'inline-flex';
                    
                    const currentTrack = cameraStream.getVideoTracks()[0];
                    const currentCamIndex = availableCameras.findIndex(d => d.deviceId === currentTrack.getSettings().deviceId);
                    currentCameraIndex = currentCamIndex !== -1 ? currentCamIndex : 0;
                };

                setInterval(updateCameraDateTime, 1000); 
            } catch (error) {
                console.error('Error starting camera:', error);
                statusDiv.innerHTML = '<span style="color: red;">❌ خطأ في الوصول للكاميرا. تأكد من السماح بالوصول.</span>';
                document.getElementById('startCameraBtn').style.display = 'inline-flex';
                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('switchCameraBtn').style.display = 'none';
                document.getElementById('stopCameraBtn').style.display = 'none';
            }
        }
        
        function switchCamera() {
            if (availableCameras.length <= 1) {
                alert('لا توجد كاميرات أخرى للتبديل إليها.');
                return;
            }
            
            stopCamera(); 
            
            currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
            const nextCameraId = availableCameras[currentCameraIndex].deviceId;
            
            startCamera(nextCameraId); 
        }

        function stopCamera() {
            const video = document.getElementById('cameraVideo');
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                cameraStream = null;
                document.getElementById('cameraStatus').innerHTML = 'الكاميرا متوقفة.';
                document.getElementById('startCameraBtn').style.display = 'inline-flex';
                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('switchCameraBtn').style.display = 'none';
                document.getElementById('stopCameraBtn').style.display = 'none';
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const overlay = document.getElementById('photoOverlay');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // إضافة الـ Overlay كنص على الصورة
            ctx.font = "24px 'Tajawal', sans-serif";
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)'; 
            ctx.fillRect(10, canvas.height - 100, canvas.width - 20, 80); 
            
            ctx.fillStyle = 'white';
            ctx.textAlign = 'right';
            const teacherName = document.getElementById('overlayTeacherName').textContent;
            const className = document.getElementById('overlayClassName').textContent;
            const dateTime = document.getElementById('overlayDateTime').textContent;
            
            ctx.fillText(teacherName, canvas.width - 20, canvas.height - 75);
            ctx.font = "20px 'Tajawal', sans-serif";
            ctx.fillText(className, canvas.width - 20, canvas.height - 50);
            ctx.font = "16px 'Tajawal', sans-serif";
            ctx.fillText(dateTime, canvas.width - 20, canvas.height - 25);


            const imageDataURL = canvas.toDataURL('image/png');
            
            // حفظ الصورة
            const photoName = `${document.getElementById('overlayTeacherName').textContent}_${new Date().getTime()}.png`;
            capturedPhotosData.push({ dataURL: imageDataURL, name: photoName });
            
            displayCapturedPhotos();
            document.getElementById('cameraStatus').innerHTML = `<span style="color: #ff6b9d;">📸 تم التقاط وحفظ صورة ${photoName}.</span>`;
        }

        function displayCapturedPhotos() {
            const grid = document.getElementById('photosGrid');
            grid.innerHTML = capturedPhotosData.map((photo, index) => `
                <div style="position: relative; border: 2px solid #ddd; border-radius: 8px; overflow: hidden;">
                    <img src="${photo.dataURL}" style="width: 100%; height: auto; display: block;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); color: white; font-size: 0.7rem; padding: 3px; text-align: center;">
                        ${photo.name.split('_')[0]}
                    </div>
                    <button onclick="deletePhoto(${index})" style="position: absolute; bottom: 0; right: 0; background: #f44336; color: white; border: none; padding: 5px; cursor: pointer; border-radius: 5px 0 0 0;">
                        🗑️
                    </button>
                </div>
            `).join('');
            
            document.getElementById('capturedPhotos').style.display = capturedPhotosData.length > 0 ? 'block' : 'none';
            document.getElementById('downloadAllBtn').style.display = capturedPhotosData.length > 0 ? 'inline-flex' : 'none';
        }

        function deletePhoto(index) {
            if (confirm('هل أنت متأكد من حذف هذه الصورة؟')) {
                capturedPhotosData.splice(index, 1);
                displayCapturedPhotos();
            }
        }

        function downloadAllPhotos() {
            if (capturedPhotosData.length === 0) {
                alert('لا توجد صور لتحميلها.');
                return;
            }

            alert('سيتم بدء تحميل الصور الآن. قد تحتاج لتأكيد تحميل كل ملف على حدة.');

            capturedPhotosData.forEach((photo, index) => {
                setTimeout(() => {
                    const a = document.createElement('a');
                    a.href = photo.dataURL;
                    a.download = photo.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }, index * 500); 
            });
        }
        
        function showTab(tabName, btn) { document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(tabName).classList.add('active'); btn.classList.add('active'); }
        function showSection(sectionName) { document.querySelectorAll('.section').forEach(section => section.classList.remove('active')); document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active')); document.querySelector(`[onclick="showSection('${sectionName}')"]`).classList.add('active'); document.getElementById(sectionName).classList.add('active'); }

        // ===================================================
        // 8. وظائف الجدولة والتهيئة (المدمجة)
        // ===================================================

        // ⭐️ دالة مسح الحضور اليومي فقط (للتشغيل التلقائي عند منتصف الليل)
        function resetDailyAttendance() {
             if (!confirm('⚠️ تنبيه: هل تريد إعادة تعيين حالات حضور المعلمات لهذا اليوم يدوياً؟')) return;
            
             teachers.forEach(t => {
                 t.status = 'not-recorded';
                 t.timestamp = '';
             });

             renderTeachers(); 
             updateDailyStars(); 
             updateStats();
             
             syncToSheet('resetAllAttendanceStatus', { id: 0 }); 

             alert('✅ تم مسح سجل الحضور اليومي بنجاح (سيتم إعادة تحميله من الشيت إذا تم تحديثه هناك).');
             loadDataFromSheet();
        }

        // ⭐️ ضبط التشغيل التلقائي عند منتصف الليل
        function scheduleDailyReset() {
            const now = new Date();
            const nextMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0);
            const msUntilMidnight = nextMidnight - now;

            console.log(`⏰ سيتم جدولة إعادة تعيين الحضور عند منتصف الليل (${nextMidnight}).`);

            setTimeout(() => {
                 alert('🔔 تنبيه: يجب أرشفة سجل الحضور الآن لبدء يوم جديد (زر "أرشفة ومسح سجل الحضور" في الإدارة).');
                 
                 scheduleDailyReset(); // إعادة جدولة اليوم التالي
            }, msUntilMidnight);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const apiLinkDisplay = document.getElementById('apiLinkDisplay');
            if (apiLinkDisplay) {
                apiLinkDisplay.textContent = SHEET_API_URL;
            }
            
            const dataLoaded = await loadDataFromSheet();
            
            if (dataLoaded) {
                updateDateTime();
                setInterval(updateDateTime, 60000); 
                
                if (document.getElementById('dataManagementInfo')) {
                    updateDataManagement();
                }
            }
            
            const motivationalTextElement = document.getElementById('motivationalText');
            if(motivationalTextElement) {
                motivationalTextElement.value = motivationalQuote;
            }
            
            // ⭐️ بدء الجدولة التلقائية للحضور
            scheduleDailyReset();

            console.log('✅ تم تحميل النظام مع محاولة مزامنة البيانات.');
        });
    </script>
</body>
</html>
